<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>–ë–∏–∑–Ω–µ—Å - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { overscroll-behavior-y: contain; touch-action: pan-y; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1a1a1a; transition: background 0.3s ease, color 0.3s ease; }
        body[data-theme="dark"] { background: #0e0e0e; color: #fff; }
        .header { position: fixed; top: calc(12px + env(safe-area-inset-top)); left: 12px; right: 12px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-radius: 24px; }
        .logo-wrap { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .logo-img { width: 40px; height: 40px; border-radius: 10px; transition: transform 0.3s; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .logo-img:hover { transform: scale(1.1) rotate(5deg); }
        h3 { font-size: 17px; font-weight: 600; margin: 0; }
        .subtitle { font-size: 12px; color: #666; margin-top: 3px; }
        body[data-theme="dark"] .subtitle { color: #999; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
        .user-avatar:hover { transform: scale(1.1); }
        .theme-toggle { background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; transition: transform 0.3s, background 0.2s; }
        .theme-toggle:hover { transform: scale(1.15) rotate(15deg); background: rgba(0, 0, 0, 0.05); }
        body[data-theme="dark"] .theme-toggle:hover { background: rgba(255, 255, 255, 0.08); }
        .map-container { position: relative; height: 100vh; width: 100%; padding-top: calc(80px + env(safe-area-inset-top)); padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
        #map { width: 100%; height: 100%; border-radius: 0; }
        .search-container { position: fixed; bottom: calc(102px + env(safe-area-inset-bottom)); left: 12px; right: 12px; z-index: 900; display: flex; flex-direction: column; gap: 8px; }
        .search-input { width: 100%; padding: 12px 16px; border: none; border-radius: 20px; font-size: 14px; outline: none; transition: box-shadow 0.3s; }
        .search-input:focus { box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
        .category-select { width: 100%; padding: 12px 16px; border: none; border-radius: 20px; font-size: 14px; outline: none; cursor: pointer; }
        @media (min-width: 768px) { .search-container { flex-direction: row; top: calc(92px + env(safe-area-inset-top)); bottom: auto; } .search-input { flex: 1; } .category-select { min-width: 180px; width: auto; } }
        .fab { position: fixed; bottom: calc(232px + env(safe-area-inset-bottom)); right: 20px; z-index: 900; width: 60px; height: 60px; border-radius: 50%; background: #007aff; color: white; border: none; font-size: 30px; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4); transition: transform 0.3s, box-shadow 0.3s; display: flex; align-items: center; justify-content: center; }
        @media (min-width: 768px) { .fab { bottom: calc(102px + env(safe-area-inset-bottom)); } }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(0, 122, 255, 0.6); }
        body[data-theme="dark"] .fab { background: #0a84ff; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex !important; }
        .modal-content { background: white; border-radius: 24px; padding: 30px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        body[data-theme="dark"] .modal-content { background: #1e1e1e; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; font-weight: 600; }
        .close-btn { background: transparent; border: none; font-size: 28px; cursor: pointer; color: #999; transition: color 0.2s; }
        .close-btn:hover { color: #333; }
        body[data-theme="dark"] .close-btn:hover { color: #fff; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 16px; font-size: 14px; outline: none; transition: border-color 0.2s; font-family: inherit; }
        body[data-theme="dark"] .form-group input, body[data-theme="dark"] .form-group textarea, body[data-theme="dark"] .form-group select { background: #2a2a2a; border-color: #444; color: #fff; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #007aff; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px 24px; border: none; border-radius: 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #007aff; color: white; }
        .btn-primary:hover { background: #0051d5; transform: translateY(-2px); }
        .btn-secondary { background: #f0f2f5; color: #333; }
        body[data-theme="dark"] .btn-secondary { background: #2a2a2a; color: #ccc; }
        .btn-secondary:hover { background: #e1e4e8; }
        .auth-prompt { text-align: center; padding: 20px; }
        .auth-prompt p { margin-bottom: 16px; color: #666; }
        .auth-prompt .btn { width: 100%; }
        .reviews-section { margin-top: 20px; }
        .reviews-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .reviews-header h3 { font-size: 16px; }
        .add-review-btn { background: #007aff; color: white; border: none; padding: 8px 16px; border-radius: 12px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        .add-review-btn:hover { background: #0051d5; }
        .review-item { padding: 12px; background: #f8f9fa; border-radius: 16px; margin-bottom: 12px; }
        body[data-theme="dark"] .review-item { background: #2a2a2a; }
        .review-item.own-review { border: 2px solid #007aff; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .review-author { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .review-author img { width: 24px; height: 24px; border-radius: 50%; }
        .review-rating { color: #f39c12; font-size: 14px; }
        .review-comment { font-size: 14px; line-height: 1.4; color: #555; }
        body[data-theme="dark"] .review-comment { color: #ccc; }
        .review-date { font-size: 12px; color: #999; margin-top: 6px; }
        .no-reviews { text-align: center; color: #999; padding: 20px; font-size: 14px; }
        .star-rating { display: flex; gap: 8px; margin-bottom: 16px; }
        .star { font-size: 32px; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .star:hover { transform: scale(1.2); }
        .star.active { color: #f39c12; }
        .star.inactive { color: #ddd; }
        .nav { position: fixed; bottom: calc(12px + env(safe-area-inset-bottom)); left: calc(12px + env(safe-area-inset-left)); right: calc(12px + env(safe-area-inset-right)); z-index: 1000; display: flex; justify-content: space-between; gap: 8px; padding: 8px; }
        .nav-block { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 24px; padding: 6px; display: flex; gap: 6px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        body[data-theme="dark"] .nav-block { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        .nav-block.left { flex: 1; max-width: 420px; }
        .nav-block.right { flex-shrink: 0; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px 16px; border-radius: 18px; cursor: pointer; text-decoration: none; color: #666; transition: all 0.2s ease; background: transparent; border: none; min-width: 0; }
        body[data-theme="dark"] .nav-btn { color: #aaa; }
        .nav-btn:hover { background: rgba(0, 0, 0, 0.06); transform: scale(1.05); }
        body[data-theme="dark"] .nav-btn:hover { background: rgba(255, 255, 255, 0.08); }
        .nav-btn.active { background: rgba(0, 122, 255, 0.15); color: #007aff; }
        body[data-theme="dark"] .nav-btn.active { background: rgba(10, 132, 255, 0.2); color: #0a84ff; }
        .nav-btn .nav-emoji { font-size: 26px; line-height: 1; }
        .nav-btn .nav-label { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        @media (max-width: 500px) { .nav-btn .nav-label { font-size: 10px; } .nav-btn { padding: 8px 12px; } }
        .liquid-glass { backdrop-filter: blur(20px) saturate(180%) brightness(1.1); -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1); }
        .header.liquid-glass { background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 2px rgba(255, 255, 255, 0.5); }
        body[data-theme="dark"] .header.liquid-glass { background: rgba(20, 20, 20, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15); }
        .search-container .liquid-glass { background: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        body[data-theme="dark"] .search-container .liquid-glass { background: rgba(30, 30, 30, 0.9); color: #fff; }
        .business-popup { padding: 10px; min-width: 200px; }
        .business-popup h3 { margin-bottom: 8px; font-size: 16px; }
        .business-popup .category { color: #666; font-size: 13px; margin-bottom: 8px; }
        .business-popup .rating { color: #f39c12; font-size: 14px; margin-bottom: 8px; }
        .business-popup .description { font-size: 14px; margin-bottom: 8px; line-height: 1.4; }
        .business-popup .address { color: #666; font-size: 12px; margin-bottom: 8px; }
        .business-popup a { color: #007aff; text-decoration: none; }
        .business-popup a:hover { text-decoration: underline; }
        .business-popup .view-reviews-btn { display: inline-block; margin-top: 8px; padding: 6px 12px; background: #007aff; color: white; border-radius: 8px; font-size: 13px; text-decoration: none; cursor: pointer; }
        .business-popup .view-reviews-btn:hover { background: #0051d5; }
    </style>
</head>
<body>
    <header class="header liquid-glass"><a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener"><img class="logo-img" src="logo.png" alt="–õ–æ–≥–æ" /><div><h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3><div class="subtitle">–ö–∞—Ä—Ç–∞ –±–∏–∑–Ω–µ—Å–∞</div></div></a><div class="header-actions"><img id="userAvatar" class="user-avatar" style="display: none;" onclick="window.location.href='profile.html'" /><button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"><span id="theme-icon">üåô</span></button></div></header>
    <div class="search-container">
        <input type="text" class="search-input liquid-glass" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å–∞...">
        <select class="category-select liquid-glass" id="categoryFilter">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã">üçΩÔ∏è –ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
            <option value="–ú–∞–≥–∞–∑–∏–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤">üõí –ú–∞–≥–∞–∑–∏–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤</option>
            <option value="–ê–ø—Ç–µ–∫–∏">üíä –ê–ø—Ç–µ–∫–∏</option>
            <option value="–°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã">üíÖ –°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã</option>
            <option value="–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç">üèãÔ∏è –§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç</option>
            <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">üè• –ú–µ–¥–∏—Ü–∏–Ω–∞</option>
            <option value="–î–µ—Ç—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã">üë∂ –î–µ—Ç—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã</option>
            <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
            <option value="–†–µ–º–æ–Ω—Ç">üîß –†–µ–º–æ–Ω—Ç</option>
            <option value="–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å—ã">üöó –ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å—ã</option>
            <option value="–•–∏–º—á–∏—Å—Ç–∫–∞/–ü—Ä–∞—á–µ—á–Ω–∞—è">üß∫ –•–∏–º—á–∏—Å—Ç–∫–∞/–ü—Ä–∞—á–µ—á–Ω–∞—è</option>
            <option value="–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã">üçï –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</option>
            <option value="–ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ">üíá –ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ</option>
            <option value="–ë–∞–Ω–∫–∏/–ë–∞–Ω–∫–æ–º–∞—Ç—ã">üè¶ –ë–∞–Ω–∫–∏/–ë–∞–Ω–∫–æ–º–∞—Ç—ã</option>
            <option value="–î—Ä—É–≥–æ–µ">üì¶ –î—Ä—É–≥–æ–µ</option>
        </select>
    </div>
    <div class="map-container"><div id="map"></div></div>
    <button class="fab" onclick="openModal()" aria-label="–î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å">+</button>
    <div id="addBusinessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="addBusinessForm">
                <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="name" required></div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select id="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã">üçΩÔ∏è –ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
                        <option value="–ú–∞–≥–∞–∑–∏–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤">üõí –ú–∞–≥–∞–∑–∏–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤</option>
                        <option value="–ê–ø—Ç–µ–∫–∏">üíä –ê–ø—Ç–µ–∫–∏</option>
                        <option value="–°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã">üíÖ –°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã</option>
                        <option value="–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç">üèãÔ∏è –§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç</option>
                        <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">üè• –ú–µ–¥–∏—Ü–∏–Ω–∞</option>
                        <option value="–î–µ—Ç—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã">üë∂ –î–µ—Ç—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã</option>
                        <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="–†–µ–º–æ–Ω—Ç">üîß –†–µ–º–æ–Ω—Ç</option>
                        <option value="–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å—ã">üöó –ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å—ã</option>
                        <option value="–•–∏–º—á–∏—Å—Ç–∫–∞/–ü—Ä–∞—á–µ—á–Ω–∞—è">üß∫ –•–∏–º—á–∏—Å—Ç–∫–∞/–ü—Ä–∞—á–µ—á–Ω–∞—è</option>
                        <option value="–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã">üçï –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</option>
                        <option value="–ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ">üíá –ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ</option>
                        <option value="–ë–∞–Ω–∫–∏/–ë–∞–Ω–∫–æ–º–∞—Ç—ã">üè¶ –ë–∞–Ω–∫–∏/–ë–∞–Ω–∫–æ–º–∞—Ç—ã</option>
                        <option value="–î—Ä—É–≥–æ–µ">üì¶ –î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="description"></textarea></div>
                <div class="form-group"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="address"></div>
                <div class="form-group"><label>–°–∞–π—Ç/–°—Å—ã–ª–∫–∞</label><input type="url" id="url"></div>
                <div class="form-group"><label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ)</label><input type="text" id="coordinates" readonly></div>
                <div class="form-group"><label>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á *</label><input type="password" id="secret" required placeholder="–ü–æ–ª—É—á–∏—Ç–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    <div id="reviewsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="reviewsBusinessName">–û—Ç–∑—ã–≤—ã</h2>
                <button class="close-btn" onclick="closeReviewsModal()">&times;</button>
            </div>
            <div class="reviews-section">
                <div class="reviews-header">
                    <h3>–û—Ç–∑—ã–≤—ã <span id="reviewCount">(0)</span></h3>
                    <button class="add-review-btn" onclick="showAddReviewForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="reviewsList"></div>
                <div id="authPrompt" class="auth-prompt" style="display: none;">
                    <p>–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</p>
                    <button class="btn btn-primary" onclick="window.location.href='profile.html'">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
                </div>
                <div id="addReviewForm" style="display: none;">
                    <h3 style="margin-bottom: 16px; font-size: 16px;">–í–∞—à –æ—Ç–∑—ã–≤</h3>
                    <div class="form-group">
                        <label>–û—Ü–µ–Ω–∫–∞ *</label>
                        <div class="star-rating" id="starRating">
                            <span class="star inactive" data-rating="1">‚òÖ</span>
                            <span class="star inactive" data-rating="2">‚òÖ</span>
                            <span class="star inactive" data-rating="3">‚òÖ</span>
                            <span class="star inactive" data-rating="4">‚òÖ</span>
                            <span class="star inactive" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="reviewComment" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="submitReview()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddReviewForm()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="nav"><div class="nav-block left"><a href="news.html" class="nav-btn"><span class="nav-emoji">üì∞</span><span class="nav-label">–ù–æ–≤–æ—Å—Ç–∏</span></a><a href="business.html" class="nav-btn active"><span class="nav-emoji">üíº</span><span class="nav-label">–ë–∏–∑–Ω–µ—Å</span></a><a href="recommendations.html" class="nav-btn"><span class="nav-emoji">‚≠ê</span><span class="nav-label">–†–µ–∫–æ–º–µ–Ω–¥.</span></a></div><div class="nav-block right"><a href="profile.html" class="nav-btn"><span class="nav-emoji">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></a></div></nav>
    <script type="text/javascript">(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106461013', 'ym');ym(106461013, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});</script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106461013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); tg.disableVerticalSwipes(); tg.setHeaderColor('#f0f2f5'); tg.setBackgroundColor('#f0f2f5'); }
        const currentUser = JSON.parse(localStorage.getItem('tgUser') || 'null');
        if (currentUser && currentUser.photoUrl) { const avatar = document.getElementById('userAvatar'); avatar.src = currentUser.photoUrl; avatar.style.display = 'block'; }
        function toggleTheme() { const body = document.body; const icon = document.getElementById('theme-icon'); const isDark = body.getAttribute('data-theme') === 'dark'; body.setAttribute('data-theme', isDark ? '' : 'dark'); icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è'; localStorage.setItem('theme', isDark ? 'light' : 'dark'); if (tg) { tg.setHeaderColor(isDark ? '#f0f2f5' : '#0e0e0e'); tg.setBackgroundColor(isDark ? '#f0f2f5' : '#0e0e0e'); } }
        function initTheme() { const saved = localStorage.getItem('theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const useDark = saved === 'dark' || (!saved && prefersDark); if (useDark) { document.body.setAttribute('data-theme', 'dark'); document.getElementById('theme-icon').textContent = '‚òÄÔ∏è'; if (tg) { tg.setHeaderColor('#0e0e0e'); tg.setBackgroundColor('#0e0e0e'); } } }
        const map = L.map('map').setView([55.592312, 37.458014], 15); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap contributors'}).addTo(map);
        let selectedCoords = null; let tempMarker = null; let allBusinesses = []; let markers = []; let currentBusinessId = null; let currentRating = 0;
        map.on('click', function(e) { selectedCoords = e.latlng; document.getElementById('coordinates').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`; if (tempMarker) map.removeLayer(tempMarker); tempMarker = L.marker([e.latlng.lat, e.latlng.lng], {icon: L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41]})}).addTo(map); if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); });
        async function loadBusinesses() { try { const res = await fetch('/api/businesses'); const data = await res.json(); allBusinesses = data.businesses || []; displayBusinesses(allBusinesses); } catch (err) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–∑–Ω–µ—Å–æ–≤:', err); } }
        
        // FIX: Create button element for review modal opener
        function createReviewButton(bizId, bizName) {
            const btn = document.createElement('button');
            btn.className = 'view-reviews-btn';
            btn.textContent = 'üìù –û—Ç–∑—ã–≤—ã';
            btn.style.cssText = 'display: inline-block; margin-top: 8px; padding: 6px 12px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;';
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                openReviewsModal(bizId, bizName);
            };
            return btn;
        }
        
        function displayBusinesses(businesses) { 
            markers.forEach(m => map.removeLayer(m)); 
            markers = []; 
            businesses.forEach(biz => { 
                const marker = L.marker([biz.lat, biz.lng]).addTo(map); 
                const popupDiv = document.createElement('div');
                popupDiv.className = 'business-popup';
                popupDiv.innerHTML = `
                    <h3>${escapeHtml(biz.name)}</h3>
                    <div class="category">${escapeHtml(biz.category)}</div>
                    ${biz.avgRating ? `<div class="rating">‚≠ê ${biz.avgRating} (${biz.reviewCount} –æ—Ç–∑—ã–≤–æ–≤)</div>` : ''}
                    ${biz.description ? `<div class="description">${escapeHtml(biz.description)}</div>` : ''}
                    ${biz.address ? `<div class="address">üìç ${escapeHtml(biz.address)}</div>` : ''}
                    ${biz.url ? `<div><a href="${escapeHtml(biz.url)}" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ ‚Üí</a></div>` : ''}
                `;
                popupDiv.appendChild(createReviewButton(biz.id, biz.name));
                marker.bindPopup(popupDiv);
                markers.push(marker); 
            }); 
        }
        
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        const searchInput = document.getElementById('searchInput'); const categoryFilter = document.getElementById('categoryFilter');
        function filterBusinesses() { const searchTerm = searchInput.value.toLowerCase(); const selectedCategory = categoryFilter.value; const filtered = allBusinesses.filter(biz => { const matchesSearch = !searchTerm || biz.name.toLowerCase().includes(searchTerm) || (biz.description && biz.description.toLowerCase().includes(searchTerm)) || (biz.address && biz.address.toLowerCase().includes(searchTerm)); const matchesCategory = !selectedCategory || biz.category === selectedCategory; return matchesSearch && matchesCategory; }); displayBusinesses(filtered); }
        searchInput.addEventListener('input', filterBusinesses); categoryFilter.addEventListener('change', filterBusinesses);
        function openModal() { document.getElementById('addBusinessModal').classList.add('active'); const savedSecret = localStorage.getItem('businessAdminKey'); if (savedSecret) { document.getElementById('secret').value = savedSecret; } if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); }
        function closeModal() { document.getElementById('addBusinessModal').classList.remove('active'); document.getElementById('addBusinessForm').reset(); if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; } selectedCoords = null; }
        document.getElementById('addBusinessForm').addEventListener('submit', async (e) => { e.preventDefault(); if (!selectedCoords) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ'); return; } const secretKey = document.getElementById('secret').value; const data = {secret: secretKey, name: document.getElementById('name').value, category: document.getElementById('category').value, description: document.getElementById('description').value, address: document.getElementById('address').value, url: document.getElementById('url').value, lat: selectedCoords.lat, lng: selectedCoords.lng}; try { const res = await fetch('/api/businesses', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)}); const result = await res.json(); if (res.ok) { localStorage.setItem('businessAdminKey', secretKey); alert('–ë–∏–∑–Ω–µ—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!'); closeModal(); window.location.reload(); } else { alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')); } } catch (err) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message); } });
        async function openReviewsModal(businessId, businessName) { currentBusinessId = businessId; document.getElementById('reviewsBusinessName').textContent = businessName; document.getElementById('reviewsModal').classList.add('active'); document.getElementById('addReviewForm').style.display = 'none'; document.getElementById('authPrompt').style.display = 'none'; await loadReviews(); if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); }
        function closeReviewsModal() { document.getElementById('reviewsModal').classList.remove('active'); currentBusinessId = null; currentRating = 0; }
        async function loadReviews() { if (!currentBusinessId) return; try { const userTgId = currentUser ? currentUser.tgId : null; const res = await fetch(`/api/reviews?businessId=${currentBusinessId}${userTgId ? '&userTgId=' + userTgId : ''}`); const data = await res.json(); const reviewsList = document.getElementById('reviewsList'); document.getElementById('reviewCount').textContent = `(${data.reviewCount})`; if (data.reviews.length === 0) { reviewsList.innerHTML = '<div class="no-reviews">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>'; return; } reviewsList.innerHTML = data.reviews.map(review => { const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating); const date = new Date(review.createdAt).toLocaleDateString('ru-RU'); const ownClass = review.isOwn ? ' own-review' : ''; return `<div class="review-item${ownClass}"><div class="review-header"><span class="review-author">${review.photoUrl ? `<img src="${escapeHtml(review.photoUrl)}" alt="">` : ''}${escapeHtml(review.userName)}${review.isOwn ? ' (–≤—ã)' : ''}</span><span class="review-rating">${stars}</span></div>${review.comment ? `<div class="review-comment">${escapeHtml(review.comment)}</div>` : ''}<div class="review-date">${date}</div></div>`; }).join(''); } catch (err) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤:', err); document.getElementById('reviewsList').innerHTML = '<div class="no-reviews">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤</div>'; } }
        function showAddReviewForm() { if (!currentUser) { document.getElementById('authPrompt').style.display = 'block'; return; } document.getElementById('addReviewForm').style.display = 'block'; if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }
        function hideAddReviewForm() { document.getElementById('addReviewForm').style.display = 'none'; document.getElementById('reviewComment').value = ''; currentRating = 0; updateStars(); }
        document.querySelectorAll('#starRating .star').forEach(star => { star.addEventListener('click', function() { currentRating = parseInt(this.getAttribute('data-rating')); updateStars(); if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }); });
        function updateStars() { document.querySelectorAll('#starRating .star').forEach(star => { const rating = parseInt(star.getAttribute('data-rating')); if (rating <= currentRating) { star.classList.add('active'); star.classList.remove('inactive'); } else { star.classList.add('inactive'); star.classList.remove('active'); } }); }
        async function submitReview() { if (!currentUser) { alert('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞'); window.location.href = 'profile.html'; return; } const comment = document.getElementById('reviewComment').value.trim(); if (currentRating === 0) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É'); return; } const data = {businessId: currentBusinessId, tgId: currentUser.tgId, userName: currentUser.displayName, photoUrl: currentUser.photoUrl || null, rating: currentRating, comment}; try { const res = await fetch('/api/reviews', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)}); const result = await res.json(); if (res.ok) { alert('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!'); hideAddReviewForm(); await loadReviews(); await loadBusinesses(); if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); } else { alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')); } } catch (err) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message); } }
        initTheme(); loadBusinesses();
    </script>
</body>
</html>