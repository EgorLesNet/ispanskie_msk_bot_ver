<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ë–∏–∑–Ω–µ—Å - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        body[data-theme="dark"] {
            background: #0e0e0e;
            color: #fff;
        }
        
        /* Header */
        .header {
            position: fixed;
            top: calc(12px + env(safe-area-inset-top));
            left: 12px;
            right: 12px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-radius: 20px;
        }
        
        .logo-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            transition: transform 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .logo-img:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        h3 {
            font-size: 17px;
            font-weight: 600;
            margin: 0;
        }
        
        .subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        body[data-theme="dark"] .subtitle {
            color: #999;
        }
        
        .theme-toggle {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: transform 0.3s, background 0.2s;
        }
        
        .theme-toggle:hover {
            transform: scale(1.15) rotate(15deg);
            background: rgba(0, 0, 0, 0.05);
        }
        
        body[data-theme="dark"] .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Map Container */
        .map-container {
            position: relative;
            height: 100vh;
            width: 100%;
            padding-top: calc(80px + env(safe-area-inset-top));
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }
        
        /* Search Bar */
        .search-container {
            position: fixed;
            top: calc(92px + env(safe-area-inset-top));
            left: 12px;
            right: 12px;
            z-index: 900;
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            outline: none;
            transition: box-shadow 0.3s;
        }
        
        .search-input:focus {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .category-select {
            padding: 12px 16px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            min-width: 120px;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: calc(102px + env(safe-area-inset-bottom));
            right: 20px;
            z-index: 900;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007aff;
            color: white;
            border: none;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.6);
        }
        
        body[data-theme="dark"] .fab {
            background: #0a84ff;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        body[data-theme="dark"] .modal-content {
            background: #1e1e1e;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        body[data-theme="dark"] .close-btn:hover {
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        body[data-theme="dark"] .form-group input,
        body[data-theme="dark"] .form-group textarea,
        body[data-theme="dark"] .form-group select {
            background: #2a2a2a;
            border-color: #444;
            color: #fff;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #007aff;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0051d5;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f0f2f5;
            color: #333;
        }
        
        body[data-theme="dark"] .btn-secondary {
            background: #2a2a2a;
            color: #ccc;
        }
        
        .btn-secondary:hover {
            background: #e1e4e8;
        }
        
        /* Navigation */
        .nav {
            position: fixed;
            bottom: calc(12px + env(safe-area-inset-bottom));
            left: calc(12px + env(safe-area-inset-left));
            right: calc(12px + env(safe-area-inset-right));
            z-index: 1000;
            display: flex;
            justify-content: center;
            padding: 10px;
            border-radius: 22px;
        }
        
        .nav-inner {
            display: flex;
            gap: 8px;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.12);
            padding: 11px 24px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #333;
            white-space: nowrap;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        body[data-theme="dark"] .nav-btn {
            background: rgba(50, 50, 50, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: #ccc;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        body[data-theme="dark"] .nav-btn:hover {
            background: rgba(70, 70, 70, 0.9);
        }
        
        .nav-btn.active {
            background: #007aff;
            color: #fff;
            border-color: #007aff;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }
        
        body[data-theme="dark"] .nav-btn.active {
            background: #0a84ff;
            border-color: #0a84ff;
        }
        
        /* Liquid Glass Effect */
        .liquid-glass {
            backdrop-filter: blur(20px) saturate(180%) brightness(1.1);
            -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1);
        }
        
        .header.liquid-glass {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        body[data-theme="dark"] .header.liquid-glass {
            background: rgba(20, 20, 20, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15);
        }
        
        .nav.liquid-glass {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.12);
        }
        
        body[data-theme="dark"] .nav.liquid-glass {
            background: rgba(20, 20, 20, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4);
        }
        
        .search-container .liquid-glass {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="dark"] .search-container .liquid-glass {
            background: rgba(30, 30, 30, 0.9);
            color: #fff;
        }
        
        /* Popup Styles */
        .business-popup {
            padding: 10px;
            min-width: 200px;
        }
        
        .business-popup h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .business-popup .category {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .business-popup .rating {
            color: #f39c12;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .business-popup .description {
            font-size: 14px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .business-popup .address {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .business-popup a {
            color: #007aff;
            text-decoration: none;
        }
        
        .business-popup a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 550px) {
            .nav-btn .nav-text {
                display: none;
            }
            .nav-btn {
                padding: 11px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header liquid-glass">
        <a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener">
            <img class="logo-img" src="logo.png" alt="–õ–æ–≥–æ" />
            <div>
                <h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3>
                <div class="subtitle">–ö–∞—Ä—Ç–∞ –±–∏–∑–Ω–µ—Å–∞</div>
            </div>
        </a>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
            <span id="theme-icon">üåô</span>
        </button>
    </header>

    <!-- Search Bar -->
    <div class="search-container">
        <input type="text" class="search-input liquid-glass" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å–∞...">
        <select class="category-select liquid-glass" id="categoryFilter">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω">–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
            <option value="–ú–∞–≥–∞–∑–∏–Ω">–ú–∞–≥–∞–∑–∏–Ω</option>
            <option value="–ü—Ä–æ–¥—É–∫—Ç—ã">–ü—Ä–æ–¥—É–∫—Ç—ã</option>
            <option value="–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç">–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç</option>
            <option value="–ö—Ä–∞—Å–æ—Ç–∞/–°–ø–∞">–ö—Ä–∞—Å–æ—Ç–∞/–°–ø–∞</option>
            <option value="–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç">–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç</option>
            <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
            <option value="–ê–ø—Ç–µ–∫–∞">–ê–ø—Ç–µ–∫–∞</option>
            <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
            <option value="–î–µ—Ç—Å–∫–∏–π —Å–∞–¥">–î–µ—Ç—Å–∫–∏–π —Å–∞–¥</option>
            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
            <option value="–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏">–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏</option>
            <option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
    </div>

    <!-- Map -->
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <!-- Add Button -->
    <button class="fab" onclick="openModal()" aria-label="–î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å">+</button>
    
    <!-- Modal -->
    <div id="addBusinessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="addBusinessForm">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select id="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω">–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                        <option value="–ú–∞–≥–∞–∑–∏–Ω">–ú–∞–≥–∞–∑–∏–Ω</option>
                        <option value="–ü—Ä–æ–¥—É–∫—Ç—ã">–ü—Ä–æ–¥—É–∫—Ç—ã</option>
                        <option value="–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç">–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç</option>
                        <option value="–ö—Ä–∞—Å–æ—Ç–∞/–°–ø–∞">–ö—Ä–∞—Å–æ—Ç–∞/–°–ø–∞</option>
                        <option value="–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç">–§–∏—Ç–Ω–µ—Å/–°–ø–æ—Ä—Ç</option>
                        <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
                        <option value="–ê–ø—Ç–µ–∫–∞">–ê–ø—Ç–µ–∫–∞</option>
                        <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="–î–µ—Ç—Å–∫–∏–π —Å–∞–¥">–î–µ—Ç—Å–∫–∏–π —Å–∞–¥</option>
                        <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                        <option value="–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏">–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏</option>
                        <option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
                        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label>–ê–¥—Ä–µ—Å</label>
                    <input type="text" id="address">
                </div>
                <div class="form-group">
                    <label>–°–∞–π—Ç/–°—Å—ã–ª–∫–∞</label>
                    <input type="url" id="url">
                </div>
                <div class="form-group">
                    <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ)</label>
                    <input type="text" id="coordinates" readonly>
                </div>
                <div class="form-group">
                    <label>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á *</label>
                    <input type="password" id="secret" required placeholder="–ü–æ–ª—É—á–∏—Ç–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav liquid-glass">
        <div class="nav-inner">
            <a href="news.html" class="nav-btn">
                <span>üì∞</span>
                <span class="nav-text"> –ù–æ–≤–æ—Å—Ç–∏</span>
            </a>
            <a href="business.html" class="nav-btn active">
                <span>üíº</span>
                <span class="nav-text"> –ë–∏–∑–Ω–µ—Å</span>
            </a>
            <a href="recommendations.html" class="nav-btn">
                <span>‚≠ê</span>
                <span class="nav-text"> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
            </a>
        </div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? '' : 'dark');
            icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        function initTheme() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const useDark = saved === 'dark' || (!saved && prefersDark);
            if (useDark) {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        // Map Setup
        const map = L.map('map').setView([55.592312, 37.458014], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let selectedCoords = null;
        let tempMarker = null;
        let allBusinesses = [];
        let markers = [];

        // Click on map to select coordinates
        map.on('click', function(e) {
            selectedCoords = e.latlng;
            document.getElementById('coordinates').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                })
            }).addTo(map);
        });

        // Load Businesses
        async function loadBusinesses() {
            try {
                const res = await fetch('/api/businesses');
                const data = await res.json();
                allBusinesses = data.businesses || [];
                displayBusinesses(allBusinesses);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–∑–Ω–µ—Å–æ–≤:', err);
            }
        }

        function displayBusinesses(businesses) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            businesses.forEach(biz => {
                const marker = L.marker([biz.lat, biz.lng]).addTo(map);
                
                const popupContent = `
                    <div class="business-popup">
                        <h3>${escapeHtml(biz.name)}</h3>
                        <div class="category">${escapeHtml(biz.category)}</div>
                        ${biz.avgRating ? `<div class="rating">‚≠ê ${biz.avgRating} (${biz.reviewCount} –æ—Ç–∑—ã–≤–æ–≤)</div>` : ''}
                        ${biz.description ? `<div class="description">${escapeHtml(biz.description)}</div>` : ''}
                        ${biz.address ? `<div class="address">üìç ${escapeHtml(biz.address)}</div>` : ''}
                        ${biz.url ? `<div><a href="${escapeHtml(biz.url)}" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ ‚Üí</a></div>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search and Filter
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');

        function filterBusinesses() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            const filtered = allBusinesses.filter(biz => {
                const matchesSearch = !searchTerm || 
                    biz.name.toLowerCase().includes(searchTerm) ||
                    (biz.description && biz.description.toLowerCase().includes(searchTerm)) ||
                    (biz.address && biz.address.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !selectedCategory || biz.category === selectedCategory;
                
                return matchesSearch && matchesCategory;
            });

            displayBusinesses(filtered);
        }

        searchInput.addEventListener('input', filterBusinesses);
        categoryFilter.addEventListener('change', filterBusinesses);

        // Modal Management
        function openModal() {
            document.getElementById('addBusinessModal').classList.add('active');
            
            // Load saved secret key
            const savedSecret = localStorage.getItem('businessAdminKey');
            if (savedSecret) {
                document.getElementById('secret').value = savedSecret;
            }
        }

        function closeModal() {
            document.getElementById('addBusinessModal').classList.remove('active');
            document.getElementById('addBusinessForm').reset();
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            selectedCoords = null;
        }

        // Form Submission
        document.getElementById('addBusinessForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedCoords) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }

            const secretKey = document.getElementById('secret').value;
            const data = {
                secret: secretKey,
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                address: document.getElementById('address').value,
                url: document.getElementById('url').value,
                lat: selectedCoords.lat,
                lng: selectedCoords.lng
            };

            try {
                const res = await fetch('/api/businesses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                
                if (res.ok) {
                    // Save secret key to localStorage
                    localStorage.setItem('businessAdminKey', secretKey);
                    
                    alert('–ë–∏–∑–Ω–µ—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    closeModal();
                    // Reload page to show new business
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            }
        });

        // Initialize
        initTheme();
        loadBusinesses();
    </script>
</body>
</html>
