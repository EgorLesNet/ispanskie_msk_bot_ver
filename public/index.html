<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>

  <!-- Leaflet (–∫–∞—Ä—Ç–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      min-height:100vh;background:#f0f2f5;color:#1a1a1a;
      transition:background 0.3s ease, color 0.3s ease;
      padding-top:calc(80px + env(safe-area-inset-top));padding-bottom:calc(90px + env(safe-area-inset-bottom))
    }
    body[data-theme="dark"]{ background:#0e0e0e; color:#fff; }

    .header{
    position:fixed;top:calc(12px + env(safe-area-inset-top));left:12px;right:12px;z-index:100;
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 18px;border-radius:20px;
    }
    .logo-wrap{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .logo-img{
      width:40px;height:40px;border-radius:10px;transition:transform 0.3s;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .logo-img:hover{transform:scale(1.1) rotate(5deg)}
    h3{font-size:17px;font-weight:600;margin:0}
    .subtitle{ font-size:12px;color:#666;margin-top:3px; }
    body[data-theme="dark"] .subtitle{color:#999}

    .theme-toggle{
      background:transparent;border:none;font-size:24px;cursor:pointer;padding:8px;
      border-radius:50%;transition:transform 0.3s,background 0.2s;
    }
    .theme-toggle:hover{transform:scale(1.15) rotate(15deg);background:rgba(0,0,0,0.05)}
    body[data-theme="dark"] .theme-toggle:hover{background:rgba(255,255,255,0.08)}

    .feed{
      display:grid;gap:16px;
      width:min(680px, 92vw);
      margin:20px auto;
    }
    .card{
      padding:18px;border-radius:20px;overflow:hidden;
      background:rgba(255,255,255,0.65);
      border:1px solid rgba(0,0,0,0.08);
      transition:transform 0.3s, box-shadow 0.3s;
      animation:fadeIn 0.5s ease-out;
    }
    body[data-theme="dark"] .card{background:rgba(30,30,30,0.65);border:1px solid rgba(255,255,255,0.1);}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,0.15);}
    body[data-theme="dark"] .card:hover{box-shadow:0 12px 32px rgba(0,0,0,0.5);}
    .card-meta{font-size:11px;color:#888;margin-bottom:10px;line-height:1.4;}
    .card-meta a{color:inherit;text-decoration:underline;}
    .card-meta a:hover{opacity:0.85;}
    .card-text{font-size:15px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;}
    .card-text a{color:#007aff;text-decoration:none;transition:color 0.2s}
    .card-text a:hover{text-decoration:underline;color:#0051d5}
    body[data-theme="dark"] .card-text a{color:#0a84ff}

/* –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
.card-media-scroll {
  display: flex !important;
  flex-direction: row;
  flex-wrap: nowrap;
  gap: 10px;
  overflow-x: scroll;
  overflow-y: hidden;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  margin: 12px -18px;
  padding: 0 18px;
  scrollbar-width: none;
}

.card-media-scroll::-webkit-scrollbar {
  display: none;
}

.card-media-scroll img,
.card-media-scroll video {
  flex-shrink: 0;
  width: 80vw;
  max-width: 400px;
  height: auto;
  max-height: 400px;
  border-radius: 12px;
  object-fit: cover;
  scroll-snap-align: center;
  display: block;
}
/* –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ - —Å–µ—Ç–∫–∞ –≤–º–µ—Å—Ç–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
@media (min-width: 768px) {
    .card-media-scroll {
          display: grid;
              grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                  gap: 10px;
                      overflow-x: visible;
                          margin: 12px 0;
                              padding: 0;
                                  scroll-snap-type: none;
                                    }
                                      
                                      .card-media-scroll img,
                                        .card-media-scroll video {
                                              flex: none;
                                                  max-width: 100%;
                                                      width: 100%;
                                                        }
                                                        }

    .no-news{text-align:center;color:#999;padding:40px 20px;font-size:15px}

    .nav{
      position:fixed;bottom:12px;left:12px;right:12px;z-index:100;
      display:flex;justify-content:center;
      padding:10px;border-radius:22px;
    }
    .nav-inner{display:flex;gap:8px;justify-content:center;width:100%;max-width:600px;}
    .nav button{
      background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.12);
      padding:11px 24px;border-radius:18px;cursor:pointer;font-size:14px;font-weight:500;
      transition:all 0.3s;color:#333;white-space:nowrap;
    }
    body[data-theme="dark"] .nav button{
      background:rgba(50,50,50,0.6);border:1px solid rgba(255,255,255,0.18);color:#ccc;
    }
    .nav button:hover{
      background:rgba(255,255,255,0.9);transform:translateY(-2px) scale(1.05);
      box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }
    body[data-theme="dark"] .nav button:hover{background:rgba(70,70,70,0.9);}
    .nav button[aria-current="true"]{
      background:#007aff;color:#fff;border-color:#007aff;
      box-shadow:0 4px 12px rgba(0,122,255,0.4);
    }
    body[data-theme="dark"] .nav button[aria-current="true"]{
      background:#0a84ff;border-color:#0a84ff;
      box-shadow:0 4px 12px rgba(10,132,255,0.4);
    }

    .liquid-glass{
      backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
      -webkit-backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
    }
    .header.liquid-glass{
      background:rgba(255,255,255,0.7);
      border:1px solid rgba(255,255,255,0.4);
      box-shadow:0 8px 32px rgba(0,0,0,0.12), inset 0 1px 2px rgba(255,255,255,0.5);
    }
    body[data-theme="dark"] .header.liquid-glass{
      background:rgba(20,20,20,0.7);
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 8px 32px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.15);
    }
    .nav.liquid-glass{
      background:rgba(255,255,255,0.7);
      border:1px solid rgba(255,255,255,0.4);
      box-shadow:0 -4px 24px rgba(0,0,0,0.12);
    }
    body[data-theme="dark"] .nav.liquid-glass{
      background:rgba(20,20,20,0.7);
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 -4px 24px rgba(0,0,0,0.4);
    }

    /* ---- Business view ---- */
    #businessView{
      width:min(900px, 94vw);
      margin:18px auto;
      display:none;
      gap:12px;
    }
    .biz-topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .biz-filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .chip{
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.6);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:transform .15s ease, background .2s ease;
    }
    body[data-theme="dark"] .chip{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(50,50,50,0.6);
      color:#ddd;
    }
    .chip.active{
      background:#007aff;
      border-color:#007aff;
      color:#fff;
    }
    body[data-theme="dark"] .chip.active{
      background:#0a84ff;
      border-color:#0a84ff;
    }
    .chip:hover{transform:scale(1.03)}

    .biz-actions{display:flex;gap:8px;align-items:center}
    .btn{
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.75);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      transition:transform .15s ease, background .2s ease;
    }
    body[data-theme="dark"] .btn{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(50,50,50,0.75);
      color:#ddd;
    }
    .btn:hover{transform:translateY(-1px)}

    .biz-layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    #map{
      height: 62vh;
      min-height: 420px;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.1);
      box-shadow:0 10px 28px rgba(0,0,0,0.12);
    }
    body[data-theme="dark"] #map{
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 10px 28px rgba(0,0,0,0.45);
    }

    .biz-form{
      display:none;
      padding:14px;
      border-radius:20px;
      background:rgba(255,255,255,0.65);
      border:1px solid rgba(0,0,0,0.08);
    }
    body[data-theme="dark"] .biz-form{
      background:rgba(30,30,30,0.65);
      border:1px solid rgba(255,255,255,0.1);
    }
    .biz-form .row{display:grid;gap:8px;margin:10px 0}
    .biz-form input, .biz-form select, .biz-form textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.9);
      font-size:14px;
    }
    body[data-theme="dark"] .biz-form input,
    body[data-theme="dark"] .biz-form select,
    body[data-theme="dark"] .biz-form textarea{
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(20,20,20,0.8);
      color:#fff;
    }
    .biz-form textarea{min-height:80px;resize:vertical}
    .hint{font-size:12px;color:#777;line-height:1.4}
    body[data-theme="dark"] .hint{color:#aaa}

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>

<body>
  <header class="header liquid-glass">
    <a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener">
      <img class="logo-img" src="https://raw.githubusercontent.com/EgorLesNet/ispanskie_msk_bot_ver/main/public/logo.png" alt="–õ–æ–≥–æ" />
      <div>
        <h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3>
        <div class="subtitle">by –ò—Å–ø–∞–Ω—Å–∫–∏–µ –ö–≤–∞—Ä—Ç–∞–ª—ã | –ü—Ä–æ–∫—à–∏–Ω–æ</div>
      </div>
    </a>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span id="theme-icon">üåô</span>
    </button>
  </header>

  <!-- NEWS VIEW -->
  <main class="feed" id="feed"></main>

  <!-- BUSINESS VIEW -->
  <section id="businessView">
    <div class="biz-topbar">
      <div class="biz-filters" id="bizFilters"></div>

      <div class="biz-actions">
        <button class="btn" id="btnSetBizSecret" type="button">üîê –°–µ–∫—Ä–µ—Ç</button>
        <button class="btn" id="btnAddBiz" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</button>
      </div>
    </div>

    <div class="biz-layout">
      <div id="map"></div>

      <div class="biz-form" id="bizForm">
        <div class="hint">
          1) –ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç–µ —Ç–æ—á–∫—É (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è).<br/>
          2) –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.<br/>
          3) –ù—É–∂–µ–Ω —Å–µ–∫—Ä–µ—Ç (–∫–Ω–æ–ø–∫–∞ ‚Äúüîê –°–µ–∫—Ä–µ—Ç‚Äù).
        </div>

        <div class="row">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="bizCategory">
            <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã">–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
            <option value="–ú–∞–≥–∞–∑–∏–Ω—ã">–ú–∞–≥–∞–∑–∏–Ω—ã</option>
            <option value="–£—Å–ª—É–≥–∏">–£—Å–ª—É–≥–∏</option>
            <option value="–ö—Ä–∞—Å–æ—Ç–∞">–ö—Ä–∞—Å–æ—Ç–∞</option>
            <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
            <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
            <option value="–î–µ—Ç–∏">–î–µ—Ç–∏</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>

        <div class="row">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="bizName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ–∫–∞—Ä–Ω—è ‚Äò–•–ª–µ–±‚Äô" />
        </div>

        <div class="row">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="bizDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –∑–∞ –±–∏–∑–Ω–µ—Å, —á–∞—Å—ã, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏"></textarea>
        </div>

        <div class="row">
          <label>–ê–¥—Ä–µ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="bizAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª. ..., –¥–æ–º ..." />
        </div>

        <div class="row">
          <label>–°—Å—ã–ª–∫–∞ (—Å–∞–π—Ç/—Ç–µ–ª–µ–≥—Ä–∞–º) (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="bizUrl" placeholder="https://t.me/..." />
        </div>

        <div class="row">
          <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
          <input id="bizLat" placeholder="lat" />
          <input id="bizLng" placeholder="lng" />
          <div class="hint" id="bizPickHint">–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.</div>
        </div>

        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="btnSaveBiz" type="button">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" id="btnCancelBiz" type="button">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </section>

  <nav class="nav liquid-glass">
    <div class="nav-inner">
      <button id="btn-all" aria-current="true" onclick="switchTab('all')">üì∞ –ù–æ–≤–æ—Å—Ç–∏</button>
      <button id="btn-business" onclick="switchTab('business')">üíº –ë–∏–∑–Ω–µ—Å</button>
      <button id="btn-reco" onclick="switchTab('reco')">‚≠ê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
    </div>
  </nav>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------------- theme ----------------
    function toggleTheme() {
      const body = document.body;
      const icon = document.getElementById('theme-icon');
      const isDark = body.getAttribute('data-theme') === 'dark';
      body.setAttribute('data-theme', isDark ? '' : 'dark');
      icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }
    function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const useDark = saved === 'dark' || (!saved && prefersDark);
      if (useDark) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
      }
    }

    // ---------------- shared helpers ----------------
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function linkify(text) {
      const safe = escapeHtml(text);
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return safe.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function formatDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${day}.${month}.${year}, ${hours}:${minutes}`;
    }
    function buildSourceLine(n) {
      const s = n && n.source ? n.source : null;
      if (!s) return '';
      const url = s.postUrl || s.chatUrl || '';
      const title = s.title || (s.username ? '@' + s.username : '–ò—Å—Ç–æ—á–Ω–∏–∫');
      if (!url) return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: ${escapeHtml(title)}`;
      return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`;
    }

    // ---------------- tabs ----------------
    let currentTab = 'all'; // all | business | reco

    function setNavActive(id) {
      document.querySelectorAll('.nav button').forEach(b => b.removeAttribute('aria-current'));
      const btn = document.getElementById('btn-' + id);
      if (btn) btn.setAttribute('aria-current', 'true');
    }

    function switchTab(tab) {
      currentTab = tab;
      setNavActive(tab);

      const feed = document.getElementById('feed');
      const businessView = document.getElementById('businessView');

      if (tab === 'business') {
        feed.style.display = 'none';
        businessView.style.display = 'grid';
        ensureMap();
        loadBusinesses({ render: true });
        return;
      }

      businessView.style.display = 'none';
      feed.style.display = 'grid';

      renderNews();
    }

    // ---------------- news ----------------
    let allNews = [];
    let hasBackgroundUpdates = false;

    function renderNews() {
      const feed = document.getElementById('feed');

      const filtered = (currentTab === 'reco')
        ? allNews.filter(n => (n.category || 'all') === 'reco')
        : allNews;

      if (!filtered.length) {
        feed.innerHTML = '<div class="no-news">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π.</div>';
        return;
      }

      feed.innerHTML = filtered.map(n => {
        const ts = n.timestamp || n.createdAt || null;
        let html = '<div class="card">';
        html += `<div class="card-meta">#${escapeHtml(n.id)} ¬∑ ${escapeHtml(formatDate(ts))}${buildSourceLine(n)}</div>`;
            
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ)
        const media = n.media || [];
            const mediaItems = media.filter(m => m && (m.type === 'photo' || m.type === 'video'));
                
                    if (mediaItems.length > 0) {
                          html += '<div class="card-media-scroll">';
                                mediaItems.forEach(item => {
                                        if (item.type === 'photo') {
                                                  html += `<img src="/api/media/${encodeURIComponent(item.fileId)}" 
                                                                          loading="lazy" 
                                                                                                  alt="–§–æ—Ç–æ"/>`;
                                                                                                                  } else if (item.type === 'video') {
                html += `<video controls preload="metadata">
                  <source src="/api/media/${encodeURIComponent(item.fileId)}" type="video/mp4">
                  –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                </video>`;
              }                                                                                           });
                                                                                                                                                                                                     html += '</div>';
                                                                                                                                                                                                         }
        html += `<div class="card-text">${linkify(n.text || '')}</div>`;
        html += '</div>';
        return html;
      }).join('');
    }

    function sameTop(a, b) {
      const a0 = (Array.isArray(a) && a.length) ? a[0] : null;
      const b0 = (Array.isArray(b) && b.length) ? b[0] : null;
      return a0 && b0 && a0.id === b0.id && a.length === b.length;
    }

    async function loadNews({ render = true } = {}) {
      try {
        const res = await fetch('/api/news', { cache: 'no-store' });
        const data = await res.json();
        const next = Array.isArray(data.posts) ? data.posts : [];

        const changed = !sameTop(allNews, next);
        allNews = next;

        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–∞ –ª–µ–Ω—Ç–∞ (–Ω–µ –∫–∞—Ä—Ç–∞)
        if (render && changed && currentTab !== 'business') renderNews();
        if (!render && changed) hasBackgroundUpdates = true;
      } catch (e) {
        console.error(e);
      }
    }

    // –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –≤ —Ñ–æ–Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ —Å–∫—Ä—ã—Ç–∞
    setInterval(() => {
      if (document.visibilityState !== 'visible') loadNews({ render: false });
    }, 3000);

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && hasBackgroundUpdates && currentTab !== 'business') {
        hasBackgroundUpdates = false;
        renderNews();
      }
    });

    // ---------------- business map ----------------
    let bizList = [];
    let bizCategoryFilter = '–í—Å–µ';

    let map = null;
    let markersLayer = null;
    let pickMarker = null;

    function ensureMap() {
      if (map) return;

      // –¶–µ–Ω—Ç—Ä —Ä–∞–π–æ–Ω–∞: –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –ø–æ–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—á–Ω–µ–µ
      const center = [55.57, 37.43];

      map = L.map('map', { zoomControl: true }).setView(center, 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);

      map.on('click', (e) => {
        const form = document.getElementById('bizForm');
        if (form.style.display !== 'block') return;

        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        document.getElementById('bizLat').value = lat.toFixed(6);
        document.getElementById('bizLng').value = lng.toFixed(6);

        if (pickMarker) pickMarker.remove();
        pickMarker = L.marker([lat, lng]).addTo(map);
        document.getElementById('bizPickHint').textContent = '–¢–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.';
      });
    }

    function buildBizFilters() {
      const container = document.getElementById('bizFilters');

      const cats = new Set(['–í—Å–µ']);
      bizList.forEach(b => cats.add(b.category || '–î—Ä—É–≥–æ–µ'));

      const items = Array.from(cats);

      container.innerHTML = items.map(c => {
        const active = c === bizCategoryFilter ? 'chip active' : 'chip';
        return `<button class="${active}" type="button" data-cat="${escapeHtml(c)}">${escapeHtml(c)}</button>`;
      }).join('');

      container.querySelectorAll('button[data-cat]').forEach(btn => {
        btn.addEventListener('click', () => {
          bizCategoryFilter = btn.getAttribute('data-cat') || '–í—Å–µ';
          buildBizFilters();
          renderBusinesses();
        });
      });
    }

    function renderBusinesses() {
      if (!map || !markersLayer) return;

      markersLayer.clearLayers();

      const filtered = (bizCategoryFilter === '–í—Å–µ')
        ? bizList
        : bizList.filter(b => (b.category || '–î—Ä—É–≥–æ–µ') === bizCategoryFilter);

      filtered.forEach(b => {
        const lat = Number(b.lat);
        const lng = Number(b.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const title = escapeHtml(b.name || '–ë–∏–∑–Ω–µ—Å');
        const cat = escapeHtml(b.category || '–î—Ä—É–≥–æ–µ');
        const desc = b.description ? `<div style="margin-top:6px;font-size:13px;line-height:1.35;">${escapeHtml(b.description)}</div>` : '';
        const addr = b.address ? `<div style="margin-top:6px;font-size:12px;opacity:0.85;">${escapeHtml(b.address)}</div>` : '';
        const link = b.url ? `<div style="margin-top:8px;"><a href="${escapeHtml(b.url)}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a></div>` : '';

        const popupHtml = `
          <div style="font-size:14px;font-weight:600;">${title}</div>
          <div style="font-size:12px;opacity:0.85;margin-top:2px;">${cat}</div>
          ${desc}
          ${addr}
          ${link}
        `;

        L.marker([lat, lng]).addTo(markersLayer).bindPopup(popupHtml);
      });
    }

    async function loadBusinesses({ render = true } = {}) {
      try {
        const res = await fetch('/api/businesses', { cache: 'no-store' });
        const data = await res.json();
        bizList = Array.isArray(data.businesses) ? data.businesses : [];
        buildBizFilters();
        if (render) renderBusinesses();
      } catch (e) {
        console.error(e);
      }
    }

    function getBizSecret() {
      return localStorage.getItem('biz_admin_secret') || '';
    }
    function setBizSecret() {
      const cur = getBizSecret();
      const s = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç BUSINESS_ADMIN_KEY (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ):', cur || '');
      if (s == null) return;
      localStorage.setItem('biz_admin_secret', s.trim());
      alert('–°–µ–∫—Ä–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    }

    function openBizForm() {
      document.getElementById('bizForm').style.display = 'block';
      document.getElementById('bizPickHint').textContent = '–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.';
    }
    function closeBizForm() {
      document.getElementById('bizForm').style.display = 'none';
      document.getElementById('bizName').value = '';
      document.getElementById('bizDesc').value = '';
      document.getElementById('bizAddress').value = '';
      document.getElementById('bizUrl').value = '';
      document.getElementById('bizLat').value = '';
      document.getElementById('bizLng').value = '';
      document.getElementById('bizPickHint').textContent = '–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.';
      if (pickMarker) { pickMarker.remove(); pickMarker = null; }
    }

    async function saveBusiness() {
      const secret = getBizSecret();
      if (!secret) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —Å–µ–∫—Ä–µ—Ç –∫–Ω–æ–ø–∫–æ–π ‚Äúüîê –°–µ–∫—Ä–µ—Ç‚Äù.');
        return;
      }

      const payload = {
        secret,
        name: document.getElementById('bizName').value,
        category: document.getElementById('bizCategory').value,
        description: document.getElementById('bizDesc').value,
        address: document.getElementById('bizAddress').value,
        url: document.getElementById('bizUrl').value,
        lat: document.getElementById('bizLat').value,
        lng: document.getElementById('bizLng').value
      };

      try {
        const res = await fetch('/api/businesses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || res.status));
          return;
        }

        closeBizForm();
        await loadBusinesses({ render: true });
        alert('–ë–∏–∑–Ω–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω!');
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.')
      }
    }

    // ---------------- init ----------------
    initTheme();
    loadNews({ render: true });
    renderNews();

    document.getElementById('btnSetBizSecret').addEventListener('click', setBizSecret);
    document.getElementById('btnAddBiz').addEventListener('click', openBizForm);
    document.getElementById('btnCancelBiz').addEventListener('click', closeBizForm);
    document.getElementById('btnSaveBiz').addEventListener('click', saveBusiness);
  </script>
</body>
</html>
