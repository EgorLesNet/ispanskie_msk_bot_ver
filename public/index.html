<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
<style>
body{
  margin:0; padding:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  min-height:100vh;
  background:#f0f2f5;
  color:#1a1a1a;
  transition:background 0.3s ease, color 0.3s ease;
}
body[data-theme="dark"]{
  background:#0e0e0e;
  color:#fff;
}

.header{
  position:sticky;top:0;z-index:100;
  display:flex;justify-content:space-between;align-items:center;
  padding:16px 20px;
  border-radius:0;
}
.logo{
  font-size:32px;text-decoration:none;line-height:1;transition:transform 0.3s;cursor:pointer;
}
.logo:hover{transform:scale(1.1)}
h3{font-size:18px;font-weight:600;margin:0}
.subtitle{
  font-size:13px;color:#666;margin-top:4px;
}
body[data-theme="dark"] .subtitle{color:#999}
.theme-toggle{
  background:transparent;border:none;font-size:26px;cursor:pointer;padding:6px;
  border-radius:50%;transition:transform 0.2s,background 0.2s;
}
.theme-toggle:hover{transform:scale(1.1);background:rgba(0,0,0,0.05)}
body[data-theme="dark"] .theme-toggle:hover{background:rgba(255,255,255,0.05)}

.feed{
  display:grid;gap:16px;
  width:min(680px, 92vw);
  margin:20px auto;
  padding-bottom:80px;
}
.card{
  padding:18px;
  border-radius:18px;
  background:rgba(255,255,255,0.6);
  border:1px solid rgba(0,0,0,0.08);
  transition:transform 0.2s, box-shadow 0.2s;
}
body[data-theme="dark"] .card{
  background:rgba(30,30,30,0.6);
  border:1px solid rgba(255,255,255,0.1);
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(0,0,0,0.12);
}
body[data-theme="dark"] .card:hover{
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.card-meta{
  font-size:12px;color:#888;margin-bottom:8px;
}
.card-text{
  font-size:15px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;
}
.card-text a{color:#007aff;text-decoration:none}
.card-text a:hover{text-decoration:underline}
body[data-theme="dark"] .card-text a{color:#0a84ff}
.card-photo{
  max-width:400px;width:100%;height:auto;display:block;margin:12px auto 12px;
  border-radius:12px;
}
.no-news{text-align:center;color:#999;padding:40px 20px;font-size:15px}

.nav{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;justify-content:center;
  padding:12px 0;
  border-radius:0;
}
.nav-inner{
  display:flex;gap:8px;justify-content:center;
}
.nav button{
  background:rgba(255,255,255,0.5);border:1px solid rgba(0,0,0,0.1);
  padding:10px 24px;border-radius:20px;cursor:pointer;font-size:14px;
  transition:all 0.2s;color:#333;
}
body[data-theme="dark"] .nav button{
  background:rgba(50,50,50,0.5);border:1px solid rgba(255,255,255,0.15);color:#ccc;
}
.nav button:hover{
  background:rgba(255,255,255,0.8);transform:translateY(-2px);
}
body[data-theme="dark"] .nav button:hover{
  background:rgba(70,70,70,0.8);
}
.nav button[aria-current="true"]{
  background:#007aff;color:#fff;border-color:#007aff;
}
body[data-theme="dark"] .nav button[aria-current="true"]{
  background:#0a84ff;border-color:#0a84ff;
}

/* Liquid glass */
.liquid-glass{
  backdrop-filter:blur(14px) url(#lg-refraction);
  -webkit-backdrop-filter:blur(14px) url(#lg-refraction);
}
.header.liquid-glass{
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.22);
  box-shadow:0 18px 60px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.35);
}
body[data-theme="dark"] .header.liquid-glass{
  background:rgba(30,30,30,0.10);
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 18px 60px rgba(0,0,0,0.35), inset 0 1px 1px rgba(255,255,255,0.15);
}
.nav.liquid-glass{
  background:rgba(255,255,255,0.10);
  border-top:1px solid rgba(0,0,0,0.08);
  box-shadow:0 -8px 30px rgba(0,0,0,0.08);
}
body[data-theme="dark"] .nav.liquid-glass{
  background:rgba(30,30,30,0.10);
  border-top:1px solid rgba(255,255,255,0.08);
  box-shadow:0 -8px 30px rgba(0,0,0,0.25);
}
</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute">
  <filter id="lg-refraction" x="-20%" y="-20%" width="140%" height="140%">
    <feTurbulence type="fractalNoise" baseFrequency="0.012" numOctaves="2" seed="2" result="noise"/>
    <feDisplacementMap in="SourceGraphic" in2="noise" scale="18" xChannelSelector="R" yChannelSelector="G"/>
  </filter>
</svg>

<div class="header liquid-glass">
  <div>
    <a href="https://t.me/ispanskie_msk" class="logo">üèòÔ∏è</a>
  </div>
  <div style="text-align:center;flex:1">
    <h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3>
    <div class="subtitle">by –ò—Å–ø–∞–Ω—Å–∫–∏–µ –ö–≤–∞—Ä—Ç–∞–ª—ã | –ü—Ä–æ–∫—à–∏–Ω–æ</div>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
    <span id="theme-icon">üåô</span>
  </button>
</div>

<div class="feed" id="feed"></div>

<div class="nav liquid-glass">
  <div class="nav-inner">
    <button onclick="filterNews('all')" aria-current="true" id="btn-all">–ù–æ–≤–æ—Å—Ç–∏</button>
    <button onclick="filterNews('business')" id="btn-business">–ë–∏–∑–Ω–µ—Å</button>
    <button onclick="filterNews('recommendations')" id="btn-recommendations">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
  </div>
</div>

<script>
let allNews = [];
let currentFilter = 'all';

// Theme
function toggleTheme() {
  const body = document.body;
  const icon = document.getElementById('theme-icon');
  const isDark = body.getAttribute('data-theme') === 'dark';
  body.setAttribute('data-theme', isDark ? '' : 'dark');
  icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const useDark = saved === 'dark' || (!saved && prefersDark);
  if (useDark) {
    document.body.setAttribute('data-theme', 'dark');
    document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
  }
}

// News
function linkify(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
}

function formatDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  const seconds = String(d.getSeconds()).padStart(2, '0');
  return `#${Math.floor(Math.random()*1000)} ¬∑ ${day}.${month}.${year}, ${hours}:${minutes}:${seconds} ¬∑ all`;
}

function renderNews() {
  const feed = document.getElementById('feed');
  const filtered = currentFilter === 'all' ? allNews : allNews.filter(n => n.category === currentFilter);
  if (!filtered.length) {
    feed.innerHTML = '<div class="no-news">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>';
    return;
  }
  feed.innerHTML = filtered.map(n => {
    let html = '<div class="card">';
    html += `<div class="card-meta">${formatDate(n.timestamp)}</div>`;
    if (n.photoFileId) {
      html += `<img class="card-photo" src="/api/photo/${n.photoFileId}" alt="photo">`;
    }
    html += `<div class="card-text">${linkify(n.text || '')}</div>`;
    html += '</div>';
    return html;
  }).join('');
}

function filterNews(cat) {
  currentFilter = cat;
  document.querySelectorAll('.nav button').forEach(b => b.removeAttribute('aria-current'));
  const btnId = `btn-${cat}`;
  const btn = document.getElementById(btnId);
  if (btn) btn.setAttribute('aria-current', 'true');
  renderNews();
}

async function loadNews() {
  try {
    const res = await fetch('/api/news');
    const data = await res.json();
    allNews = Array.isArray(data) ? data : [];
    renderNews();
  } catch (e) {
    console.error(e);
  }
}

initTheme();
loadNews();
</script>
</body>
</html>
