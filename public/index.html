<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      min-height:100vh;background:#f0f2f5;color:#1a1a1a;
      transition:background 0.3s ease, color 0.3s ease;
      padding-top:80px;padding-bottom:100px;
    }
    body[data-theme="dark"]{ background:#0e0e0e; color:#fff; }

    .header{
      position:fixed;top:12px;left:12px;right:12px;z-index:100;
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 18px;border-radius:20px;
    }
    .logo-wrap{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .logo-img{
      width:40px;height:40px;border-radius:10px;transition:transform 0.3s;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .logo-img:hover{transform:scale(1.1) rotate(5deg)}
    h3{font-size:17px;font-weight:600;margin:0}
    .subtitle{ font-size:12px;color:#666;margin-top:3px; }
    body[data-theme="dark"] .subtitle{color:#999}

    .theme-toggle{
      background:transparent;border:none;font-size:24px;cursor:pointer;padding:8px;
      border-radius:50%;transition:transform 0.3s,background 0.2s;
    }
    .theme-toggle:hover{transform:scale(1.15) rotate(15deg);background:rgba(0,0,0,0.05)}
    body[data-theme="dark"] .theme-toggle:hover{background:rgba(255,255,255,0.08)}

    .feed{
      display:grid;gap:16px;
      width:min(680px, 92vw);
      margin:20px auto;
    }
    .card{
      padding:18px;border-radius:20px;overflow:hidden;
      background:rgba(255,255,255,0.65);
      border:1px solid rgba(0,0,0,0.08);
      transition:transform 0.3s, box-shadow 0.3s;
      animation:fadeIn 0.5s ease-out;
    }
    body[data-theme="dark"] .card{background:rgba(30,30,30,0.65);border:1px solid rgba(255,255,255,0.1);}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,0.15);}
    body[data-theme="dark"] .card:hover{box-shadow:0 12px 32px rgba(0,0,0,0.5);}
    .card-meta{font-size:11px;color:#888;margin-bottom:10px;line-height:1.4;}
    .card-meta a{color:inherit;text-decoration:underline;}
    .card-meta a:hover{opacity:0.85;}
    .card-text{font-size:15px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;}
    .card-text a{color:#007aff;text-decoration:none;transition:color 0.2s}
    .card-text a:hover{text-decoration:underline;color:#0051d5}
    body[data-theme="dark"] .card-text a{color:#0a84ff}

    .no-news{text-align:center;color:#999;padding:40px 20px;font-size:15px}

    .liquid-glass{
      backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
      -webkit-backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
    }
    .header.liquid-glass{
      background:rgba(255,255,255,0.7);
      border:1px solid rgba(255,255,255,0.4);
      box-shadow:0 8px 32px rgba(0,0,0,0.12), inset 0 1px 2px rgba(255,255,255,0.5);
    }
    body[data-theme="dark"] .header.liquid-glass{
      background:rgba(20,20,20,0.7);
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 8px 32px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.15);
    }

    /* Business view */
    #businessView{
      width:min(900px, 94vw);
      margin:18px auto;
      display:none;
      gap:12px;
    }
    .biz-topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .biz-search{
      flex:1;min-width:200px;
    }
    .biz-search input{
      width:100%;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.75);
      font-size:14px;
    }
    body[data-theme="dark"] .biz-search input{
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(50,50,50,0.75);
      color:#fff;
    }
    .biz-filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .chip{
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.6);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:transform .15s ease, background .2s ease;
    }
    body[data-theme="dark"] .chip{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(50,50,50,0.6);
      color:#ddd;
    }
    .chip.active{
      background:#007aff;
      border-color:#007aff;
      color:#fff;
    }
    body[data-theme="dark"] .chip.active{
      background:#0a84ff;
      border-color:#0a84ff;
    }
    .chip:hover{transform:scale(1.03)}

    .biz-actions{display:flex;gap:8px;align-items:center}
    .btn{
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.75);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      transition:transform .15s ease, background .2s ease;
    }
    body[data-theme="dark"] .btn{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(50,50,50,0.75);
      color:#ddd;
    }
    .btn:hover{transform:translateY(-1px)}

    .biz-layout{display:grid;gap:12px;}
    #map{
      height: 50vh;
      min-height: 350px;
      max-height: calc(100vh - 280px);
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.1);
      box-shadow:0 10px 28px rgba(0,0,0,0.12);
    }
    body[data-theme="dark"] #map{
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 10px 28px rgba(0,0,0,0.45);
    }
    @media (max-height: 600px) {
      #map{
        height: 40vh;
        min-height: 280px;
        max-height: calc(100vh - 320px);
      }
    }

    .biz-form{
      display:none;
      padding:14px;
      border-radius:20px;
      background:rgba(255,255,255,0.65);
      border:1px solid rgba(0,0,0,0.08);
    }
    body[data-theme="dark"] .biz-form{
      background:rgba(30,30,30,0.65);
      border:1px solid rgba(255,255,255,0.1);
    }
    .biz-form .row{display:grid;gap:8px;margin:10px 0}
    .biz-form input, .biz-form select, .biz-form textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.9);
      font-size:14px;
    }
    body[data-theme="dark"] .biz-form input,
    body[data-theme="dark"] .biz-form select,
    body[data-theme="dark"] .biz-form textarea{
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(20,20,20,0.8);
      color:#fff;
    }
    .biz-form textarea{min-height:80px;resize:vertical}
    .hint{font-size:12px;color:#777;line-height:1.4}
    body[data-theme="dark"] .hint{color:#aaa}

    /* Modal –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ */
    .modal{
      display:none;
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal.show{display:flex}
    .modal-content{
      background:rgba(255,255,255,0.95);
      border-radius:20px;
      max-width:600px;
      width:100%;
      max-height:85vh;
      overflow-y:auto;
      padding:20px;
      animation:slideUp 0.3s ease-out;
    }
    body[data-theme="dark"] .modal-content{
      background:rgba(30,30,30,0.95);
      border:1px solid rgba(255,255,255,0.1);
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:16px;border-bottom:1px solid rgba(0,0,0,0.1);
      padding-bottom:12px;
    }
    body[data-theme="dark"] .modal-header{
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    .modal-close{
      background:none;border:none;font-size:24px;cursor:pointer;padding:0;
      color:inherit;transition:opacity 0.2s;
    }
    .modal-close:hover{opacity:0.6}

    .reviews-list{
      display:grid;gap:12px;margin:16px 0;
    }
    .review-item{
      padding:12px;
      border-radius:12px;
      background:rgba(0,0,0,0.03);
      border-left:3px solid #007aff;
    }
    body[data-theme="dark"] .review-item{
      background:rgba(255,255,255,0.05);
      border-left-color:#0a84ff;
    }
    .review-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:6px;font-size:13px;
    }
    .review-author{font-weight:600}
    .review-rating{font-weight:600;color:#ffc107}
    .review-text{font-size:13px;line-height:1.4;margin:8px 0 0 0}
    .review-date{font-size:11px;color:#888;margin-top:8px}
    body[data-theme="dark"] .review-date{color:#aaa}

    .review-form{
      padding:12px;border-radius:12px;
      background:rgba(0,0,0,0.03);
      margin-top:16px;
    }
    body[data-theme="dark"] .review-form{
      background:rgba(255,255,255,0.05);
    }
    .review-form-row{margin:10px 0}
    .review-form-row label{
      display:block;font-size:13px;font-weight:600;margin-bottom:4px;
    }
    .review-form-row input, .review-form-row select, .review-form-row textarea{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(255,255,255,0.9);
      font-size:13px;
    }
    body[data-theme="dark"] .review-form-row input,
    body[data-theme="dark"] .review-form-row select,
    body[data-theme="dark"] .review-form-row textarea{
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(20,20,20,0.8);
      color:#fff;
    }
    .review-form-row textarea{min-height:70px;resize:vertical}

    .no-reviews{font-size:13px;color:#999;padding:12px 0;text-align:center}

    /* –î–∏—Å–∫–ª–µ–π–º–µ—Ä ‚Äî –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π */
    .disclaimer{
      position:fixed;
      bottom:78px;
      left:50%;
      transform:translateX(-50%);
      background:transparent;
      padding:6px 12px;
      font-size:9px;
      line-height:1.3;
      color:#999;
      text-align:center;
      z-index:60;
      pointer-events:none;
      max-width:90vw;
    }
    body[data-theme="dark"] .disclaimer{color:#666}

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî Liquid Glass UI */
    .nav{
      position:fixed;
      bottom:12px;
      left:12px;
      right:12px;
      z-index:99;
      display:flex;
      justify-content:center;
      padding:10px;
      border-radius:20px;
      background:rgba(255,255,255,0.7);
      border:1px solid rgba(255,255,255,0.4);
      box-shadow:0 8px 32px rgba(0,0,0,0.12), inset 0 1px 2px rgba(255,255,255,0.5);
      backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
      -webkit-backdrop-filter:blur(20px) saturate(180%) brightness(1.1);
    }
    body[data-theme="dark"] .nav{
      background:rgba(20,20,20,0.7);
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 8px 32px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.15);
    }

    .nav-inner{
      display:flex;
      gap:8px;
      justify-content:center;
      width:100%;
      max-width:600px;
      flex-wrap:wrap;
    }

    .nav button{
      background:rgba(255,255,255,0.6);
      border:1px solid rgba(0,0,0,0.12);
      padding:11px 24px;
      border-radius:18px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all 0.3s;
      color:#333;
      white-space:nowrap;
    }
    body[data-theme="dark"] .nav button{
      background:rgba(50,50,50,0.6);
      border:1px solid rgba(255,255,255,0.18);
      color:#ccc;
    }
    .nav button:hover{
      background:rgba(255,255,255,0.9);
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }
    body[data-theme="dark"] .nav button:hover{
      background:rgba(70,70,70,0.9);
    }
    .nav button[aria-current="true"]{
      background:#007aff;
      color:#fff;
      border-color:#007aff;
      box-shadow:0 4px 12px rgba(0,122,255,0.4);
    }
    body[data-theme="dark"] .nav button[aria-current="true"]{
      background:#0a84ff;
      border-color:#0a84ff;
      box-shadow:0 4px 12px rgba(10,132,255,0.4);
    }

    @media (max-width: 480px) {
      .nav button{
        padding:9px 14px;
        font-size:12px;
      }
      .nav-inner{
        gap:6px;
      }
      .disclaimer{
        font-size:8px;
        padding:4px 8px;
        bottom:74px;
      }
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>

<body>
  <header class="header liquid-glass">
    <a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener">
      <img class="logo-img" src="https://raw.githubusercontent.com/EgorLesNet/ispanskie_msk_bot_ver/main/public/logo.png" alt="–õ–æ–≥–æ" />
      <div>
        <h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3>
        <div class="subtitle">by –ò—Å–ø–∞–Ω—Å–∫–∏–µ –ö–≤–∞—Ä—Ç–∞–ª—ã | –ü—Ä–æ–∫—à–∏–Ω–æ</div>
      </div>
    </a>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span id="theme-icon">üåô</span>
    </button>
  </header>

  <main class="feed" id="feed"></main>

  <section id="businessView">
    <div class="biz-topbar">
      <div class="biz-search">
        <input id="bizSearchInput" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å–∞..." />
      </div>
      <div class="biz-filters" id="bizFilters"></div>

      <div class="biz-actions">
        <button class="btn" id="btnSetBizSecret" type="button">üîê</button>
        <button class="btn" id="btnAddBiz" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</button>
      </div>
    </div>

    <div class="biz-layout">
      <div id="map"></div>

      <div class="biz-form" id="bizForm">
        <div class="hint">
          1) –ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç–µ —Ç–æ—á–∫—É (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è).<br/>
          2) –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å".<br/>
          3) –ù—É–∂–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (–∫–Ω–æ–ø–∫–∞ "üîê").
        </div>

        <div class="row">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="bizCategory">
            <option value="–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã">–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
            <option value="–ú–∞–≥–∞–∑–∏–Ω—ã">–ú–∞–≥–∞–∑–∏–Ω—ã</option>
            <option value="–£—Å–ª—É–≥–∏">–£—Å–ª—É–≥–∏</option>
            <option value="–ö—Ä–∞—Å–æ—Ç–∞">–ö—Ä–∞—Å–æ—Ç–∞</option>
            <option value="–ú–µ–¥–∏—Ü–∏–Ω–∞">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
            <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
            <option value="–î–µ—Ç–∏">–î–µ—Ç–∏</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>

        <div class="row">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="bizName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ–∫–∞—Ä–Ω—è ¬´–•–ª–µ–±¬ª" />
        </div>

        <div class="row">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="bizDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –∑–∞ –±–∏–∑–Ω–µ—Å, —á–∞—Å—ã, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏"></textarea>
        </div>

        <div class="row">
          <label>–ê–¥—Ä–µ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="bizAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª. ..., –¥–æ–º ..." />
        </div>

        <div class="row">
          <label>–°—Å—ã–ª–∫–∞ (—Å–∞–π—Ç/—Ç–µ–ª–µ–≥—Ä–∞–º) (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="bizUrl" placeholder="https://t.me/..." />
        </div>

        <div class="row">
          <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
          <input id="bizLat" placeholder="lat" />
          <input id="bizLng" placeholder="lng" />
          <div class="hint" id="bizPickHint">–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.</div>
        </div>

        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="btnSaveBiz" type="button">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" id="btnCancelBiz" type="button">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
  <div class="modal" id="reviewsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">–û—Ç–∑—ã–≤—ã</h3>
        <button class="modal-close" onclick="closeReviewsModal()">‚úï</button>
      </div>

      <div id="modalBusinessInfo" style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(0,0,0,0.1)">
        <!-- –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>

      <div id="reviewsList" class="reviews-list">
        <!-- –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–∑—ã–≤—ã -->
      </div>

      <div class="no-reviews" id="noReviews">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>

      <div class="review-form">
        <h4 style="margin:0 0 12px 0;font-size:14px">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
        <div class="review-form-row">
          <label>–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="reviewAuthor" type="text" placeholder="–ê–Ω–æ–Ω–∏–º" />
        </div>
        <div class="review-form-row">
          <label>–û—Ü–µ–Ω–∫–∞</label>
          <select id="reviewRating">
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 –∑–≤—ë–∑–¥</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 –∑–≤–µ–∑–¥—ã</option>
            <option value="3">‚≠ê‚≠ê‚≠ê 3 –∑–≤–µ–∑–¥—ã</option>
            <option value="2">‚≠ê‚≠ê 2 –∑–≤–µ–∑–¥—ã</option>
            <option value="1">‚≠ê 1 –∑–≤–µ–∑–¥–∞</option>
          </select>
        </div>
        <div class="review-form-row">
          <label>–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</label>
          <textarea id="reviewText" placeholder="–ü–æ–¥–µ–ª–∏—Å—å —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º..."></textarea>
        </div>
        <button class="btn" id="btnSubmitReview" type="button">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
      </div>
    </div>
  </div>

  <!-- –î–∏—Å–∫–ª–µ–π–º–µ—Ä -->
  <footer class="disclaimer">
    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–∞ –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–∞–π—Ç ‚Äî —Å–±–æ—Ä–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–∑–∏—Ü–∏–π –∞–≤—Ç–æ—Ä–æ–≤.
  </footer>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="nav">
    <div class="nav-inner">
      <button id="btn-all" aria-current="true" onclick="switchTab('all')">üì∞ –ù–æ–≤–æ—Å—Ç–∏</button>
      <button id="btn-business" onclick="switchTab('business')">üíº –ë–∏–∑–Ω–µ—Å</button>
      <button id="btn-reco" onclick="switchTab('reco')">‚≠ê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
    </div>
  </nav>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>

  <script>
    // ============ –ò–ö–û–ù–ö–ò –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú ============
    const categoryIcons = {
      '–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã': 'üçΩÔ∏è',
      '–ú–∞–≥–∞–∑–∏–Ω—ã': 'üõçÔ∏è',
      '–£—Å–ª—É–≥–∏': 'üîß',
      '–ö—Ä–∞—Å–æ—Ç–∞': 'üíÑ',
      '–ú–µ–¥–∏—Ü–∏–Ω–∞': 'üè•',
      '–°–ø–æ—Ä—Ç': '‚öΩ',
      '–î–µ—Ç–∏': 'üë∂',
      '–î—Ä—É–≥–æ–µ': 'üìç'
    };

    const categoryColors = {
      '–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã': '#FF6B6B',
      '–ú–∞–≥–∞–∑–∏–Ω—ã': '#4ECDC4',
      '–£—Å–ª—É–≥–∏': '#45B7D1',
      '–ö—Ä–∞—Å–æ—Ç–∞': '#F7DC6F',
      '–ú–µ–¥–∏—Ü–∏–Ω–∞': '#BB8FCE',
      '–°–ø–æ—Ä—Ç': '#52C41A',
      '–î–µ—Ç–∏': '#FF85C0',
      '–î—Ä—É–≥–æ–µ': '#8E8E93'
    };

    function getCategoryIcon(category) {
      return categoryIcons[category] || 'üìç';
    }

    function getCategoryColor(category) {
      return categoryColors[category] || '#8E8E93';
    }

    function createCustomIcon(category) {
      const icon = getCategoryIcon(category);
      const color = getCategoryColor(category);

      const html = `
        <div style="
          display:flex;align-items:center;justify-content:center;
          width:40px;height:40px;
          background:${color};
          border-radius:50%;
          font-size:20px;
          box-shadow:0 2px 8px rgba(0,0,0,0.3);
          border:3px solid white;
        ">${icon}</div>
      `;

      return L.divIcon({
        html,
        className: 'custom-marker',
        iconSize: [40, 40],
        popupAnchor: [0, -20]
      });
    }

    // ============ THEME ============
    function toggleTheme() {
      const body = document.body;
      const icon = document.getElementById('theme-icon');
      const isDark = body.getAttribute('data-theme') === 'dark';
      body.setAttribute('data-theme', isDark ? '' : 'dark');
      icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }
    function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const useDark = saved === 'dark' || (!saved && prefersDark);
      if (useDark) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
      }
    }

    // ============ HELPERS ============
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function linkify(text) {
      const safe = escapeHtml(text);
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return safe.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function formatDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${day}.${month}.${year}, ${hours}:${minutes}`;
    }
    function buildSourceLine(n) {
      const s = n && n.source ? n.source : null;
      if (!s) return '';
      const url = s.postUrl || s.chatUrl || '';
      const title = s.title || (s.username ? '@' + s.username : '–ò—Å—Ç–æ—á–Ω–∏–∫');
      if (!url) return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: ${escapeHtml(title)}`;
      return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`;
    }

    // ============ TABS & NAVIGATION ============
    let currentTab = 'all';
    let allNews = [];
    let bizList = [];
    let bizCategoryFilter = '–í—Å–µ';
    let bizSearchText = '';
    let hasBackgroundUpdates = false;

    function setNavActive(tab) {
      document.querySelectorAll('.nav button').forEach(b => b.removeAttribute('aria-current'));
      const btn = document.getElementById('btn-' + tab);
      if (btn) btn.setAttribute('aria-current', 'true');
    }

    function switchTab(tab) {
      currentTab = tab;
      setNavActive(tab);
      const feed = document.getElementById('feed');
      const bizView = document.getElementById('businessView');
      if (tab === 'business') {
        feed.style.display = 'none';
        bizView.style.display = 'grid';
        ensureMap();
        loadBusinesses({ render: true });
      } else {
        bizView.style.display = 'none';
        feed.style.display = 'grid';
        renderNews();
      }
    }

    // ============ NEWS ============
    function sameTop(a, b) {
      const a0 = (Array.isArray(a) && a.length) ? a[0] : null;
      const b0 = (Array.isArray(b) && b.length) ? b[0] : null;
      return a0 && b0 && a0.id === b0.id && a.length === b.length;
    }

    async function loadNews({ render = true } = {}) {
      try {
        const res = await fetch('/api/news', { cache: 'no-store' });
        const data = await res.json();
        const next = Array.isArray(data.posts) ? data.posts : [];
        const changed = !sameTop(allNews, next);
        allNews = next;
        if (render && changed && currentTab !== 'business') renderNews();
        if (!render && changed) hasBackgroundUpdates = true;
      } catch (e) {
        console.error(e);
      }
    }

    function renderNews() {
      const feed = document.getElementById('feed');
      const filtered =
        currentTab === 'reco'
          ? allNews.filter(n => (n.category || 'all') === 'reco')
          : allNews;

      if (!filtered.length) {
        feed.innerHTML = '<div class="no-news">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π.</div>';
        return;
      }

      feed.innerHTML = filtered
        .map(n => {
          const ts = n.timestamp || n.createdAt || null;
          let html = '<div class="card">';
          html += `<div class="card-meta">#${escapeHtml(n.id)} ¬∑ ${escapeHtml(
            formatDate(ts)
          )}${buildSourceLine(n)}</div>`;
          html += `<div class="card-text">${linkify(n.text || '')}</div>`;
          html += '</div>';
          return html;
        })
        .join('');
    }

    setInterval(() => {
      if (document.visibilityState !== 'visible') loadNews({ render: false });
    }, 3000);

    document.addEventListener('visibilitychange', () => {
      if (
        document.visibilityState === 'visible' &&
        hasBackgroundUpdates &&
        currentTab !== 'business'
      ) {
        hasBackgroundUpdates = false;
        renderNews();
      }
    });

    // ============ BUSINESS MAP ============
    let map = null;
    let markerClusterGroup = null;
    let pickMarker = null;
    let currentBusinessId = null;

    function ensureMap() {
      if (map) return;
      const center = [55.57, 37.43];

      map = L.map('map', { zoomControl: true }).setView(center, 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      markerClusterGroup = L.markerClusterGroup();
      map.addLayer(markerClusterGroup);

      map.on('click', (e) => {
        const form = document.getElementById('bizForm');
        if (form.style.display !== 'block') return;
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        document.getElementById('bizLat').value = lat.toFixed(6);
        document.getElementById('bizLng').value = lng.toFixed(6);
        if (pickMarker) pickMarker.remove();
        pickMarker = L.marker([lat, lng]).addTo(map);
        document.getElementById('bizPickHint').textContent =
          '–¢–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.';
      });
    }

    function buildBizFilters() {
      const container = document.getElementById('bizFilters');
      const cats = new Set(['–í—Å–µ']);
      bizList.forEach(b => cats.add(b.category || '–î—Ä—É–≥–æ–µ'));
      const items = Array.from(cats);
      container.innerHTML = items
        .map(c => {
          const active = c === bizCategoryFilter ? 'chip active' : 'chip';
          return `<button class="${active}" type="button" data-cat="${escapeHtml(
            c
          )}">${escapeHtml(c)}</button>`;
        })
        .join('');
      container.querySelectorAll('button[data-cat]').forEach(btn => {
        btn.addEventListener('click', () => {
          bizCategoryFilter = btn.getAttribute('data-cat') || '–í—Å–µ';
          buildBizFilters();
          renderBusinesses();
        });
      });
    }

    function filterBusinesses() {
      let filtered = bizList;

      if (bizCategoryFilter !== '–í—Å–µ') {
        filtered = filtered.filter(b => (b.category || '–î—Ä—É–≥–æ–µ') === bizCategoryFilter);
      }

      if (bizSearchText.trim()) {
        const q = bizSearchText.toLowerCase();
        filtered = filtered.filter(b => {
          const name = (b.name || '').toLowerCase();
          const desc = (b.description || '').toLowerCase();
          const addr = (b.address || '').toLowerCase();
          return name.includes(q) || desc.includes(q) || addr.includes(q);
        });
      }

      return filtered;
    }

    function renderBusinesses() {
      if (!map || !markerClusterGroup) return;
      markerClusterGroup.clearLayers();

      const filtered = filterBusinesses();

      filtered.forEach(b => {
        const lat = Number(b.lat);
        const lng = Number(b.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const title = escapeHtml(b.name || '–ë–∏–∑–Ω–µ—Å');
        const cat = escapeHtml(b.category || '–î—Ä—É–≥–æ–µ');
        const desc = b.description ? `<div style="margin-top:6px;font-size:13px;line-height:1.35;">${escapeHtml(b.description)}</div>` : '';
        const addr = b.address ? `<div style="margin-top:6px;font-size:12px;opacity:0.85;">${escapeHtml(b.address)}</div>` : '';
        const link = b.url ? `<div style="margin-top:8px;"><a href="${escapeHtml(b.url)}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a></div>` : '';

        const avgRating = b.reviews && Array.isArray(b.reviews) && b.reviews.length
          ? (b.reviews.reduce((s, r) => s + Number(r.rating || 0), 0) / b.reviews.length).toFixed(1)
          : null;
        const ratingLine = avgRating ? `<div style="margin-top:8px;color:#ffc107;font-weight:600;">‚≠ê ${avgRating} (${b.reviews.length} –æ—Ç–∑—ã–≤–æ–≤)</div>` : '';

        const popupHtml = `
          <div style="font-size:14px;font-weight:600;">${title}</div>
          <div style="font-size:12px;opacity:0.85;margin-top:2px;">${cat}</div>
          ${desc}
          ${addr}
          ${ratingLine}
          ${link}
          <div style="margin-top:12px;"><button onclick="openReviewsModal(${b.id})" style="padding:6px 12px;background:#007aff;color:white;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;">üí¨ –û—Ç–∑—ã–≤—ã</button></div>
        `;

        const marker = L.marker([lat, lng], {
          icon: createCustomIcon(b.category || '–î—Ä—É–≥–æ–µ')
        }).bindPopup(popupHtml);

        markerClusterGroup.addLayer(marker);
      });
    }

    async function loadBusinesses({ render = true } = {}) {
      try {
        const res = await fetch('/api/businesses', { cache: 'no-store' });
        const data = await res.json();
        bizList = Array.isArray(data.businesses) ? data.businesses : [];
        buildBizFilters();
        if (render) renderBusinesses();
      } catch (e) {
        console.error(e);
      }
    }

    // ============ BUSINESS CRUD ============
    function getBizSecret() {
      return localStorage.getItem('biz_admin_secret') || '';
    }
    function setBizSecret() {
      const cur = getBizSecret();
      const s = prompt(
        '–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ BUSINESS_ADMIN_KEY (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ):',
        cur || ''
      );
      if (s == null) return;
      localStorage.setItem('biz_admin_secret', s.trim());
      alert('–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    }

    function openBizForm() {
      document.getElementById('bizForm').style.display = 'block';
      document.getElementById('bizPickHint').textContent =
        '–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.';
    }
    function closeBizForm() {
      document.getElementById('bizForm').style.display = 'none';
      document.getElementById('bizName').value = '';
      document.getElementById('bizDesc').value = '';
      document.getElementById('bizAddress').value = '';
      document.getElementById('bizUrl').value = '';
      document.getElementById('bizLat').value = '';
      document.getElementById('bizLng').value = '';
      document.getElementById('bizPickHint').textContent =
        '–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.';
      if (pickMarker) {
        pickMarker.remove();
        pickMarker = null;
      }
    }

    async function saveBusiness() {
      const secret = getBizSecret();
      if (!secret) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –∫–Ω–æ–ø–∫–æ–π "üîê".');
        return;
      }
      const payload = {
        action: 'add',
        secret,
        name: document.getElementById('bizName').value,
        category: document.getElementById('bizCategory').value,
        description: document.getElementById('bizDesc').value,
        address: document.getElementById('bizAddress').value,
        url: document.getElementById('bizUrl').value,
        lat: document.getElementById('bizLat').value,
        lng: document.getElementById('bizLng').value
      };
      try {
        const res = await fetch('/api/businesses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || res.status));
          return;
        }
        closeBizForm();
        await loadBusinesses({ render: true });
        alert('–ë–∏–∑–Ω–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω!');
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
      }
    }

    // ============ REVIEWS ============
    function openReviewsModal(businessId) {
      currentBusinessId = businessId;
      const biz = bizList.find(b => b.id === businessId);
      if (!biz) return;

      document.getElementById('modalTitle').textContent = `–û—Ç–∑—ã–≤—ã ‚Äî ${biz.name}`;

      const infoDiv = document.getElementById('modalBusinessInfo');
      const reviews = Array.isArray(biz.reviews) ? biz.reviews : [];
      const avgRating = reviews.length
        ? (reviews.reduce((s, r) => s + Number(r.rating || 0), 0) / reviews.length).toFixed(1)
        : '–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫';
      infoDiv.innerHTML = `
        <div>
          <strong>${escapeHtml(biz.name)}</strong><br/>
          <small style="color:#888">${escapeHtml(biz.category || '–î—Ä—É–≥–æ–µ')}</small><br/>
          <div style="margin-top:8px;">
            ${reviews.length ? `‚≠ê ${avgRating} (${reviews.length} –æ—Ç–∑—ã–≤–æ–≤)` : '–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤'}
          </div>
        </div>
      `;

      const listDiv = document.getElementById('reviewsList');
      const noDiv = document.getElementById('noReviews');

      if (reviews.length) {
        noDiv.style.display = 'none';
        listDiv.innerHTML = reviews.map(r => `
          <div class="review-item">
            <div class="review-header">
              <span class="review-author">${escapeHtml(r.author || '–ê–Ω–æ–Ω–∏–º')}</span>
              <span class="review-rating">${'‚≠ê'.repeat(Number(r.rating || 0))}</span>
            </div>
            <div class="review-text">${escapeHtml(r.text || '')}</div>
            <div class="review-date">${formatDate(r.createdAt)}</div>
          </div>
        `).join('');
      } else {
        noDiv.style.display = 'block';
        listDiv.innerHTML = '';
      }

      document.getElementById('reviewAuthor').value = '';
      document.getElementById('reviewRating').value = '5';
      document.getElementById('reviewText').value = '';

      document.getElementById('reviewsModal').classList.add('show');
    }

    function closeReviewsModal() {
      document.getElementById('reviewsModal').classList.remove('show');
      currentBusinessId = null;
    }

    async function submitReview() {
      if (!currentBusinessId) return;
      const author = document.getElementById('reviewAuthor').value;
      const rating = Number(document.getElementById('reviewRating').value);
      const text = document.getElementById('reviewText').value;

      if (!text.trim()) {
        alert('–ù–∞–ø–∏—à–∏ –æ—Ç–∑—ã–≤!');
        return;
      }

      const payload = {
        action: 'review',
        businessId: currentBusinessId,
        author: author || '–ê–Ω–æ–Ω–∏–º',
        rating,
        text
      };

      try {
        const res = await fetch('/api/businesses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞: ' + (data.error || res.status));
          return;
        }
        await loadBusinesses({ render: false });
        openReviewsModal(currentBusinessId);
        alert('–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.');
      }
    }

    // ============ SEARCH ============
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('bizSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          bizSearchText = e.target.value;
          renderBusinesses();
        });
      }
    });

    // ============ INIT ============
    initTheme();
    loadNews({ render: true });
    renderNews();

    document.getElementById('btnSetBizSecret').addEventListener('click', setBizSecret);
    document.getElementById('btnAddBiz').addEventListener('click', openBizForm);
    document.getElementById('btnCancelBiz').addEventListener('click', closeBizForm);
    document.getElementById('btnSaveBiz').addEventListener('click', saveBusiness);
    document.getElementById('btnSubmitReview').addEventListener('click', submitReview);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–µ–π –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    document.getElementById('reviewsModal').addEventListener('click', (e) => {
      if (e.target.id === 'reviewsModal') closeReviewsModal();
    });
  </script>
</body>
</html>
