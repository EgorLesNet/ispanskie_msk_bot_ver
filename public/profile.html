<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { overscroll-behavior-y: contain; touch-action: pan-y; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1a1a1a; padding: 20px; padding-top: calc(20px + env(safe-area-inset-top)); padding-bottom: calc(100px + env(safe-area-inset-bottom)); transition: background 0.3s ease, color 0.3s ease; }
        body[data-theme="dark"] { background: #0e0e0e; color: #fff; }
        .container { max-width: 600px; margin: 0 auto; }
        .profile-card { background: white; border-radius: 24px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        body[data-theme="dark"] .profile-card { background: #1e1e1e; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .profile-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .profile-info h2 { font-size: 24px; margin-bottom: 4px; }
        .profile-info .username { color: #666; font-size: 14px; }
        body[data-theme="dark"] .profile-info .username { color: #999; }
        .logout-btn { background: #ff3b30; color: white; border: none; padding: 10px 20px; border-radius: 16px; cursor: pointer; font-size: 14px; margin-top: 20px; transition: background 0.3s; }
        .logout-btn:hover { background: #d62d20; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
        .review-item { background: #f8f9fa; border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        body[data-theme="dark"] .review-item { background: #2a2a2a; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .business-name { font-weight: 600; font-size: 15px; }
        .review-rating { color: #f39c12; }
        .review-comment { font-size: 14px; line-height: 1.4; color: #555; margin-bottom: 8px; }
        body[data-theme="dark"] .review-comment { color: #ccc; }
        .review-date { font-size: 12px; color: #999; }
        .no-reviews { text-align: center; color: #999; padding: 40px; }
        .auth-card { background: white; border-radius: 24px; padding: 40px; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        body[data-theme="dark"] .auth-card { background: #1e1e1e; }
        .auth-card h2 { margin-bottom: 16px; font-size: 28px; }
        .auth-card p { color: #666; margin-bottom: 24px; line-height: 1.6; font-size: 16px; }
        body[data-theme="dark"] .auth-card p { color: #999; }
        .tg-login-container { display: flex; justify-content: center; margin-top: 20px; }
        .nav { position: fixed; bottom: calc(12px + env(safe-area-inset-bottom)); left: calc(12px + env(safe-area-inset-left)); right: calc(12px + env(safe-area-inset-right)); z-index: 1000; display: flex; justify-content: space-between; gap: 8px; padding: 8px; }
        .nav-block { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 24px; padding: 6px; display: flex; gap: 6px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        body[data-theme="dark"] .nav-block { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        .nav-block.left { flex: 1; max-width: 420px; }
        .nav-block.right { flex-shrink: 0; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px 16px; border-radius: 18px; cursor: pointer; text-decoration: none; color: #666; transition: all 0.2s ease; background: transparent; border: none; min-width: 0; }
        body[data-theme="dark"] .nav-btn { color: #aaa; }
        .nav-btn:hover { background: rgba(0, 0, 0, 0.06); transform: scale(1.05); }
        body[data-theme="dark"] .nav-btn:hover { background: rgba(255, 255, 255, 0.08); }
        .nav-btn.active { background: rgba(0, 122, 255, 0.15); color: #007aff; }
        body[data-theme="dark"] .nav-btn.active { background: rgba(10, 132, 255, 0.2); color: #0a84ff; }
        .nav-btn .nav-emoji { font-size: 26px; line-height: 1; }
        .nav-btn .nav-label { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        @media (max-width: 500px) { .nav-btn .nav-label { font-size: 10px; } .nav-btn { padding: 8px 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="authView" class="auth-card" style="display: none;">
            <h2>üëã –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram</h2>
            <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã –Ω–∞ –±–∏–∑–Ω–µ—Å—ã –∏ –≤–∏–¥–µ—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é. –≠—Ç–æ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ!</p>
            <div class="tg-login-container">
                <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="ispanskie_msk_bot" 
                    data-size="large" 
                    data-radius="16"
                    data-onauth="onTelegramAuth(user)" 
                    data-request-access="write">
                </script>
            </div>
        </div>

        <div id="profileView" style="display: none;">
            <div class="profile-card">
                <div class="profile-header">
                    <img id="profilePhoto" class="profile-photo" src="" alt="">
                    <div class="profile-info">
                        <h2 id="profileName"></h2>
                        <div id="profileUsername" class="username"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>

            <div class="profile-card">
                <div class="section-title">–ú–æ–∏ –æ—Ç–∑—ã–≤—ã</div>
                <div id="reviewsList"></div>
            </div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-block left">
            <a href="news.html" class="nav-btn"><span class="nav-emoji">üì∞</span><span class="nav-label">–ù–æ–≤–æ—Å—Ç–∏</span></a>
            <a href="business.html" class="nav-btn"><span class="nav-emoji">üíº</span><span class="nav-label">–ë–∏–∑–Ω–µ—Å</span></a>
            <a href="recommendations.html" class="nav-btn"><span class="nav-emoji">‚≠ê</span><span class="nav-label">–†–µ–∫–æ–º–µ–Ω–¥.</span></a>
        </div>
        <div class="nav-block right">
            <a href="profile.html" class="nav-btn active"><span class="nav-emoji">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></a>
        </div>
    </nav>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); tg.disableVerticalSwipes(); tg.setHeaderColor('#f0f2f5'); tg.setBackgroundColor('#f0f2f5'); }
        
        const user = JSON.parse(localStorage.getItem('tgUser') || 'null');
        if (user) { showProfile(); } else { document.getElementById('authView').style.display = 'block'; }

        function onTelegramAuth(tgUser) {
            fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tgUser)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('tgUser', JSON.stringify(data.user));
                    location.reload();
                }
            })
            .catch(err => { alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'); });
        }

        function showProfile() {
            document.getElementById('authView').style.display = 'none';
            document.getElementById('profileView').style.display = 'block';
            document.getElementById('profileName').textContent = user.displayName;
            document.getElementById('profileUsername').textContent = user.username ? '@' + user.username : 'ID: ' + user.tgId;
            if (user.photoUrl) { document.getElementById('profilePhoto').src = user.photoUrl; } else { document.getElementById('profilePhoto').src = 'https://via.placeholder.com/80/007aff/ffffff?text=' + user.displayName.charAt(0); }
            loadUserReviews();
        }

        async function loadUserReviews() {
            try {
                const bizRes = await fetch('/api/businesses');
                const bizData = await bizRes.json();
                const businesses = bizData.businesses || [];
                const userReviews = [];
                for (const biz of businesses) {
                    if (biz.reviews) {
                        const userReview = biz.reviews.find(r => String(r.tgId) === String(user.tgId));
                        if (userReview) { userReviews.push({ ...userReview, businessName: biz.name, businessId: biz.id }); }
                    }
                }
                const reviewsList = document.getElementById('reviewsList');
                if (userReviews.length === 0) { reviewsList.innerHTML = '<div class="no-reviews">–í—ã –µ—â—ë –Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤–æ–≤</div>'; return; }
                reviewsList.innerHTML = userReviews.map(review => {
                    const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                    const date = new Date(review.createdAt).toLocaleDateString('ru-RU');
                    return `<div class="review-item"><div class="review-header"><div class="business-name">${escapeHtml(review.businessName)}</div><div class="review-rating">${stars}</div></div>${review.comment ? `<div class="review-comment">${escapeHtml(review.comment)}</div>` : ''}<div class="review-date">${date}</div></div>`;
                }).join('');
            } catch (err) { console.error('Error loading reviews:', err); }
        }

        function logout() { if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) { localStorage.removeItem('tgUser'); location.reload(); } }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    </script>
</body>
</html>