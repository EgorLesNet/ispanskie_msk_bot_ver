<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { overscroll-behavior-y: contain; touch-action: pan-y; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height: 100vh; background: #f0f2f5; color: #1a1a1a; padding-top: calc(80px + env(safe-area-inset-top)); padding-bottom: calc(100px + env(safe-area-inset-bottom)); padding-left: 20px; padding-right: 20px; transition: background 0.3s ease, color 0.3s ease; }
    body[data-theme="dark"] { background: #0e0e0e; color: #fff; }
    .header { position: fixed; top: calc(12px + env(safe-area-inset-top)); left: 12px; right: 12px; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-radius: 50px; }
    .logo-wrap { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
    .logo-img { width: 40px; height: 40px; border-radius: 20px; transition: transform 0.3s; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .logo-img:hover { transform: scale(1.1) rotate(5deg); }
    h3 { font-size: 17px; font-weight: 600; margin: 0; }
    .subtitle { font-size: 12px; color: #666; margin-top: 3px; }
    body[data-theme="dark"] .subtitle { color: #999; }
    .theme-toggle { background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; transition: transform 0.3s, background 0.2s; }
    .theme-toggle:hover { transform: scale(1.15) rotate(15deg); background: rgba(0, 0, 0, 0.05); }
    body[data-theme="dark"] .theme-toggle:hover { background: rgba(255, 255, 255, 0.08); }
    .liquid-glass { backdrop-filter: blur(20px) saturate(180%) brightness(1.1); -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1); }
    .header.liquid-glass { background: rgba(255, 255, 255, 0.65); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 2px rgba(255, 255, 255, 0.5); }
    body[data-theme="dark"] .header.liquid-glass { background: rgba(20, 20, 20, 0.65); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15); }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 28px; font-weight: 600; margin-bottom: 30px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 40px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); transition: transform 0.3s; }
    body[data-theme="dark"] .stat-card { background: #1e1e1e; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
    .stat-card:hover { transform: translateY(-4px); }
    .stat-label { font-size: 14px; color: #666; margin-bottom: 8px; }
    body[data-theme="dark"] .stat-label { color: #999; }
    .stat-value { font-size: 36px; font-weight: 700; color: #007aff; }
    .stat-icon { font-size: 32px; margin-bottom: 12px; }
    .section-title { font-size: 22px; font-weight: 600; margin: 30px 0 16px; }
    .top-list { background: white; padding: 20px; border-radius: 40px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); margin-bottom: 24px; }
    body[data-theme="dark"] .top-list { background: #1e1e1e; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
    .top-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
    body[data-theme="dark"] .top-item { border-bottom: 1px solid #333; }
    .top-item:last-child { border-bottom: none; }
    .top-rank { font-size: 24px; font-weight: 700; width: 40px; text-align: center; color: #007aff; }
    .top-content { flex: 1; margin: 0 16px; }
    .top-title { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
    .top-meta { font-size: 13px; color: #666; }
    body[data-theme="dark"] .top-meta { color: #999; }
    .top-score { font-size: 20px; font-weight: 600; color: #007aff; }
    .loading { text-align: center; padding: 60px 20px; color: #999; font-size: 16px; }
    
    /* Login form */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); }
    .login-box { background: white; padding: 40px; border-radius: 50px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); max-width: 400px; width: 90%; }
    body[data-theme="dark"] .login-box { background: #1e1e1e; }
    .login-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; text-align: center; }
    .login-subtitle { font-size: 14px; color: #666; text-align: center; margin-bottom: 24px; }
    body[data-theme="dark"] .login-subtitle { color: #999; }
    .login-input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 32px; font-size: 16px; margin-bottom: 16px; background: white; color: #1a1a1a; transition: border-color 0.3s; }
    body[data-theme="dark"] .login-input { background: #2a2a2a; border-color: #444; color: white; }
    .login-input:focus { outline: none; border-color: #007aff; }
    .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; border: none; border-radius: 40px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 20px rgba(0,122,255,0.35); }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,122,255,0.5); }
    .login-error { color: #ff3b30; font-size: 14px; text-align: center; margin-top: 12px; display: none; }
    .hidden { display: none; }
    
    /* Navigation */
    .nav { position: fixed; bottom: calc(12px + env(safe-area-inset-bottom)); left: calc(12px + env(safe-area-inset-left)); right: calc(12px + env(safe-area-inset-right)); z-index: 100; display: flex; justify-content: space-between; gap: 8px; padding: 8px; }
    .nav-block { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0, 0, 0, 0.05); border-radius: 50px; padding: 6px; display: flex; gap: 6px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); }
    body[data-theme="dark"] .nav-block { background: rgba(30, 30, 30, 0.5); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); }
    .nav-block.left { flex: 1; max-width: 420px; }
    .nav-block.right { flex-shrink: 0; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px 16px; border-radius: 36px; cursor: pointer; text-decoration: none; color: #666; transition: all 0.2s ease; background: transparent; border: none; min-width: 0; }
    body[data-theme="dark"] .nav-btn { color: #aaa; }
    .nav-btn:hover { background: rgba(0, 0, 0, 0.06); transform: scale(1.05); }
    body[data-theme="dark"] .nav-btn:hover { background: rgba(255, 255, 255, 0.08); }
    .nav-btn.active { background: rgba(0, 122, 255, 0.15); color: #007aff; }
    body[data-theme="dark"] .nav-btn.active { background: rgba(10, 132, 255, 0.2); color: #0a84ff; }
    .nav-btn .nav-emoji { font-size: 26px; line-height: 1; }
    .nav-btn .nav-label { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    @media (max-width: 500px) { .nav-btn .nav-label { font-size: 10px; } .nav-btn { padding: 8px 12px; } }
  </style>
</head>
<body>
  <!-- Login overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-title">üîí –î–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ</div>
      <div class="login-subtitle">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
      <input type="password" class="login-input" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" />
      <button class="login-btn" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
      <div class="login-error" id="loginError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>

  <!-- Header -->
  <header class="header liquid-glass"><a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener"><img class="logo-img" src="logo.png" alt="–õ–æ–≥–æ" /><div><h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3><div class="subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div></a><button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"><span id="theme-icon">üåô</span></button></header>

  <!-- Main content -->
  <div class="container hidden" id="mainContent">
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h1>

    <div class="stats-grid" id="mainStats">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
    </div>

    <h2 class="section-title">üèÜ –¢–æ–ø –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</h2>
    <div class="top-list" id="topPosts">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <h2 class="section-title">‚≠ê –¢–æ–ø –∞–≤—Ç–æ—Ä–æ–≤</h2>
    <div class="top-list" id="topAuthors">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
  
  <!-- Navigation -->
  <nav class="nav"><div class="nav-block left"><a href="news.html" class="nav-btn"><span class="nav-emoji">üì∞</span><span class="nav-label">–ù–æ–≤–æ—Å—Ç–∏</span></a><a href="business.html" class="nav-btn"><span class="nav-emoji">üíº</span><span class="nav-label">–ë–∏–∑–Ω–µ—Å</span></a><a href="recommendations.html" class="nav-btn"><span class="nav-emoji">‚≠ê</span><span class="nav-label">–†–µ–∫–æ–º–µ–Ω–¥.</span></a></div><div class="nav-block right"><a href="profile.html" class="nav-btn"><span class="nav-emoji">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></a></div></nav>

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106461013', 'ym');ym(106461013, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});</script>
  <noscript><div><img src="https://mc.yandex.ru/watch/106461013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); tg.disableVerticalSwipes(); tg.setHeaderColor('#f0f2f5'); tg.setBackgroundColor('#f0f2f5'); }
    
    const CORRECT_PASSWORD = 'business key';

    function checkPassword() {
      const input = document.getElementById('passwordInput');
      const error = document.getElementById('loginError');
      const overlay = document.getElementById('loginOverlay');
      const content = document.getElementById('mainContent');

      if (input.value === CORRECT_PASSWORD) {
        sessionStorage.setItem('statsAuth', 'true');
        overlay.classList.add('hidden');
        content.classList.remove('hidden');
        loadStats();
        if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
      } else {
        error.style.display = 'block';
        input.value = '';
        input.focus();
        if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('passwordInput');
      input.focus();
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPassword();
      });

      if (sessionStorage.getItem('statsAuth') === 'true') {
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        loadStats();
      }
    });

    function toggleTheme() {
      const body = document.body;
      const icon = document.getElementById('theme-icon');
      const isDark = body.getAttribute('data-theme') === 'dark';
      body.setAttribute('data-theme', isDark ? '' : 'dark');
      icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      if (tg) { tg.setHeaderColor(isDark ? '#f0f2f5' : '#0e0e0e'); tg.setBackgroundColor(isDark ? '#f0f2f5' : '#0e0e0e'); }
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const useDark = saved === 'dark' || (!saved && prefersDark);
      if (useDark) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        if (tg) { tg.setHeaderColor('#0e0e0e'); tg.setBackgroundColor('#0e0e0e'); }
      }
    }

    function escapeHtml(s) {
      return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/news?limit=1000&offset=0', { cache: 'no-store' });
        const data = await res.json();
        const posts = data.posts || [];

        const totalPosts = posts.length;
        const totalLikes = posts.reduce((sum, p) => sum + (p.likes || 0), 0);
        const totalDislikes = posts.reduce((sum, p) => sum + (p.dislikes || 0), 0);
        const postsWithMedia = posts.filter(p => p.media && p.media.length > 0).length;
        const uniqueAuthors = new Set(posts.map(p => p.authorUsername).filter(Boolean)).size;

        document.getElementById('mainStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-icon">üì∞</div>
            <div class="stat-label">–í—Å–µ–≥–æ –Ω–æ–≤–æ—Å—Ç–µ–π</div>
            <div class="stat-value">${totalPosts}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üëç</div>
            <div class="stat-label">–õ–∞–π–∫–æ–≤</div>
            <div class="stat-value">${totalLikes}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üëé</div>
            <div class="stat-label">–î–∏–∑–ª–∞–π–∫–æ–≤</div>
            <div class="stat-value">${totalDislikes}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üì∏</div>
            <div class="stat-label">–° –º–µ–¥–∏–∞</div>
            <div class="stat-value">${postsWithMedia}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úçÔ∏è</div>
            <div class="stat-label">–ê–≤—Ç–æ—Ä–æ–≤</div>
            <div class="stat-value">${uniqueAuthors}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-label">–°—Ä. –ª–∞–π–∫–æ–≤ –Ω–∞ –ø–æ—Å—Ç</div>
            <div class="stat-value">${totalPosts ? Math.round(totalLikes / totalPosts) : 0}</div>
          </div>
        `;

        const topPosts = posts
          .map(p => ({ ...p, score: (p.likes || 0) - (p.dislikes || 0) }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 10);

        document.getElementById('topPosts').innerHTML = topPosts.map((p, i) => `
          <div class="top-item">
            <div class="top-rank">${i + 1}</div>
            <div class="top-content">
              <div class="top-title">${escapeHtml(p.text.substring(0, 80))}${p.text.length > 80 ? '...' : ''}</div>
              <div class="top-meta">#${p.id} ¬∑ ${p.authorName || 'Unknown'}</div>
            </div>
            <div class="top-score">
              <span style="color: #34c759;">‚Üë${p.likes || 0}</span>
              <span style="color: #ff3b30; margin-left: 8px;">‚Üì${p.dislikes || 0}</span>
            </div>
          </div>
        `).join('');

        const authorsMap = {};
        posts.forEach(p => {
          const author = p.authorUsername || 'unknown';
          if (!authorsMap[author]) {
            authorsMap[author] = { name: p.authorName || author, count: 0, likes: 0 };
          }
          authorsMap[author].count++;
          authorsMap[author].likes += (p.likes || 0);
        });

        const topAuthors = Object.entries(authorsMap)
          .map(([username, data]) => ({ username, ...data }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 10);

        document.getElementById('topAuthors').innerHTML = topAuthors.map((a, i) => `
          <div class="top-item">
            <div class="top-rank">${i + 1}</div>
            <div class="top-content">
              <div class="top-title">${escapeHtml(a.name)}</div>
              <div class="top-meta">@${escapeHtml(a.username)} ¬∑ ${a.count} –Ω–æ–≤–æ—Å—Ç–µ–π</div>
            </div>
            <div class="top-score">üëç ${a.likes}</div>
          </div>
        `).join('');

      } catch (e) {
        console.error('Failed to load stats:', e);
        document.getElementById('mainStats').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    initTheme();
  </script>
</body>
</html>