<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#007aff" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  
  <!-- Telegram WebApp SDK (loaded conditionally) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- App Adapter - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ -->
  <script src="/app-adapter.js"></script>
  <script src="/navigation.js"></script>

  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { overscroll-behavior-y: contain; touch-action: pan-y; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height: 100vh; background: #f0f2f5; color: #1a1a1a; transition: background 0.3s ease, color 0.3s ease; padding-top: calc(80px + env(safe-area-inset-top)); padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
    body[data-theme="dark"] { background: #0e0e0e; color: #fff; }
    .header { position: fixed; top: calc(12px + env(safe-area-inset-top)); left: 12px; right: 12px; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-radius: 50px; }
    .logo-wrap { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
    .logo-img { width: 40px; height: 40px; border-radius: 20px; transition: transform 0.3s; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .logo-img:hover { transform: scale(1.1) rotate(5deg); }
    h3 { font-size: 17px; font-weight: 600; margin: 0; }
    .subtitle { font-size: 12px; color: #666; margin-top: 3px; }
    body[data-theme="dark"] .subtitle { color: #999; }
    .theme-toggle { background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; transition: transform 0.3s, background 0.2s; }
    .theme-toggle:hover { transform: scale(1.15) rotate(15deg); background: rgba(0, 0, 0, 0.05); }
    body[data-theme="dark"] .theme-toggle:hover { background: rgba(255, 255, 255, 0.08); }
    
    /* AI Summary Button */
    .summary-container { width: min(680px, 92vw); margin: 0 auto 16px; }
    .summary-btn { width: 100%; padding: 16px 24px; border: none; border-radius: 40px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 24px rgba(0, 122, 255, 0.35); }
    .summary-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0, 122, 255, 0.5); }
    .summary-btn:active { transform: translateY(0px); }
    .summary-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .summary-card { padding: 24px; border-radius: 40px; background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(0, 0, 0, 0.08); margin-bottom: 16px; animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); }
    body[data-theme="dark"] .summary-card { background: rgba(30, 30, 30, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
    .summary-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; font-size: 18px; font-weight: 700; color: #007aff; }
    body[data-theme="dark"] .summary-header { color: #0a84ff; }
    .summary-text { font-size: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
    .summary-footer { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0, 0, 0, 0.08); font-size: 13px; color: #666; display: flex; justify-content: space-between; align-items: center; }
    body[data-theme="dark"] .summary-footer { border-top: 1px solid rgba(255, 255, 255, 0.1); color: #999; }
    .summary-close { background: transparent; border: none; color: #666; cursor: pointer; padding: 8px; font-size: 24px; line-height: 1; transition: color 0.2s; }
    .summary-close:hover { color: #333; }
    body[data-theme="dark"] .summary-close:hover { color: #fff; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    
    .feed { display: grid; gap: 16px; width: min(680px, 92vw); margin: 20px auto; }
    .card { padding: 20px; border-radius: 40px; overflow: hidden; background: rgba(255, 255, 255, 0.65); border: 1px solid rgba(0, 0, 0, 0.08); transition: transform 0.3s, box-shadow 0.3s; animation: fadeIn 0.5s ease-out; }
    body[data-theme="dark"] .card { background: rgba(30, 30, 30, 0.65); border: 1px solid rgba(255, 255, 255, 0.1); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15); }
    body[data-theme="dark"] .card:hover { box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5); }
    .card-meta { font-size: 11px; color: #888; margin-bottom: 10px; line-height: 1.4; }
    .card-meta a { color: inherit; text-decoration: underline; }
    .card-text { font-size: 15px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
    .card-text a { color: #007aff; text-decoration: none; transition: color 0.2s; }
    .card-text a:hover { text-decoration: underline; color: #0051d5; }
    body[data-theme="dark"] .card-text a { color: #0a84ff; }
    .card-media-scroll { display: flex !important; flex-direction: row; flex-wrap: nowrap; gap: 10px; overflow-x: scroll; overflow-y: hidden; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; margin: 12px -20px; padding: 0 20px; scrollbar-width: none; }
    .card-media-scroll::-webkit-scrollbar { display: none; }
    .card-media-scroll img, .card-media-scroll video { flex-shrink: 0; width: 80vw; max-width: 400px; height: auto; max-height: 400px; border-radius: 32px; object-fit: cover; scroll-snap-align: center; display: block; }
    @media (min-width: 768px) { .card-media-scroll { display: grid !important; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; overflow-x: visible; margin: 12px 0; padding: 0; scroll-snap-type: none; } .card-media-scroll img, .card-media-scroll video { flex: none; max-width: 100%; width: 100%; } }
    .card-reactions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 0, 0, 0.08); }
    body[data-theme="dark"] .card-reactions { border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .reaction-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border: 2px solid rgba(0, 0, 0, 0.12); background: rgba(255, 255, 255, 0.8); border-radius: 32px; cursor: pointer; font-size: 14px; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; position: relative; }
    body[data-theme="dark"] .reaction-btn { background: rgba(50, 50, 50, 0.8); border: 2px solid rgba(255, 255, 255, 0.15); }
    .reaction-btn:active { transform: scale(0.95); }
    .reaction-btn:hover:not(.active) { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); border-color: rgba(0, 0, 0, 0.2); }
    .reaction-btn.active { background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); border-color: #007aff; color: #fff; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4); transform: scale(1.05); }
    .reaction-btn .emoji { font-size: 20px; line-height: 1; transition: transform 0.2s; }
    .reaction-btn.active .emoji { transform: scale(1.2); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)); }
    .reaction-btn .count { font-weight: 600; min-width: 20px; text-align: center; font-size: 15px; }
    .loading { text-align: center; color: #999; padding: 40px 20px; font-size: 15px; }
    .no-news { text-align: center; color: #999; padding: 40px 20px; font-size: 15px; }
    .error-msg { text-align: center; color: #ff3b30; padding: 40px 20px; font-size: 15px; background: rgba(255, 59, 48, 0.1); border-radius: 40px; margin: 20px; }
    .load-more { text-align: center; padding: 20px; }
    .load-more-btn { background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 32px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
    .load-more-btn:hover { background: #0051d5; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4); }
    .nav { position: fixed; bottom: calc(12px + env(safe-area-inset-bottom)); left: calc(12px + env(safe-area-inset-left)); right: calc(12px + env(safe-area-inset-right)); z-index: 100; display: flex; justify-content: space-between; gap: 8px; padding: 8px; }
    .nav-block { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0, 0, 0, 0.05); border-radius: 50px; padding: 6px; display: flex; gap: 6px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); }
    body[data-theme="dark"] .nav-block { background: rgba(30, 30, 30, 0.5); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); }
    .nav-block.left { flex: 1; max-width: 420px; }
    .nav-block.right { flex-shrink: 0; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px 16px; border-radius: 36px; cursor: pointer; text-decoration: none; color: #666; transition: all 0.2s ease; background: transparent; border: none; min-width: 0; }
    body[data-theme="dark"] .nav-btn { color: #aaa; }
    .nav-btn:hover { background: rgba(0, 0, 0, 0.06); transform: scale(1.05); }
    body[data-theme="dark"] .nav-btn:hover { background: rgba(255, 255, 255, 0.08); }
    .nav-btn.active { background: rgba(0, 122, 255, 0.15); color: #007aff; }
    body[data-theme="dark"] .nav-btn.active { background: rgba(10, 132, 255, 0.2); color: #0a84ff; }
    .nav-btn .nav-emoji { font-size: 26px; line-height: 1; }
    .nav-btn .nav-label { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    @media (max-width: 500px) { .nav-btn .nav-label { font-size: 10px; } .nav-btn { padding: 8px 12px; } }
    .liquid-glass { backdrop-filter: blur(20px) saturate(180%) brightness(1.1); -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1); }
    .header.liquid-glass { background: rgba(255, 255, 255, 0.65); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 2px rgba(255, 255, 255, 0.5); }
    body[data-theme="dark"] .header.liquid-glass { background: rgba(20, 20, 20, 0.65); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15); }
    .auth-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.3s ease-out; }
    .auth-modal.active { display: flex; }
    .auth-modal-content { background: white; border-radius: 50px; padding: 40px 30px; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out; }
    body[data-theme="dark"] .auth-modal-content { background: #1e1e1e; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .auth-modal h2 { font-size: 26px; margin-bottom: 12px; }
    .auth-modal p { color: #666; margin-bottom: 24px; line-height: 1.5; }
    body[data-theme="dark"] .auth-modal p { color: #999; }
    .auth-modal-btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; border: none; padding: 14px 28px; border-radius: 40px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 20px rgba(0,122,255,0.35); width: 100%; margin-bottom: 12px; }
    .auth-modal-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,122,255,0.5); }
    .auth-modal-cancel { background: #f0f2f5; color: #333; box-shadow: none; }
    body[data-theme="dark"] .auth-modal-cancel { background: #2a2a2a; color: #ccc; }
    .auth-modal-cancel:hover { background: #e1e4e8; }
    body[data-theme="dark"] .auth-modal-cancel:hover { background: #333; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <header class="header liquid-glass"><a class="logo-wrap" href="https://t.me/ispanskie_msk" target="_blank" rel="noopener"><img class="logo-img" src="logo.png" alt="–õ–æ–≥–æ" /><div><h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–π–æ–Ω–∞</h3><div class="subtitle">by –ò—Å–ø–∞–Ω—Å–∫–∏–µ –ö–≤–∞—Ä—Ç–∞–ª—ã | –ü—Ä–æ–∫—à–∏–Ω–æ</div></div></a><button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"><span id="theme-icon">üåô</span></button></header>
  
  <div class="summary-container">
    <button class="summary-btn" id="summaryBtn" onclick="loadSummary()">
      <span>ü§ñ</span>
      <span>–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è?</span>
    </button>
    <div id="summaryCard" style="display: none;"></div>
  </div>
  
  <main class="feed" id="feed"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div></main>
  <div class="auth-modal" id="authModal"><div class="auth-modal-content"><h2>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥</h2><p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–∞–∫—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</p><button class="auth-modal-btn" onclick="goToProfile()">‚úàÔ∏è –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button><button class="auth-modal-btn auth-modal-cancel" onclick="closeAuthModal()">–û—Ç–º–µ–Ω–∞</button></div></div>
  <nav class="nav"><div class="nav-block left"><a href="news.html" class="nav-btn active"><span class="nav-emoji">üì∞</span><span class="nav-label">–ù–æ–≤–æ—Å—Ç–∏</span></a><a href="business.html" class="nav-btn"><span class="nav-emoji">üíº</span><span class="nav-label">–ë–∏–∑–Ω–µ—Å</span></a><a href="recommendations.html" class="nav-btn"><span class="nav-emoji">‚≠ê</span><span class="nav-label">–†–µ–∫–æ–º–µ–Ω–¥.</span></a></div><div class="nav-block right"><a href="profile.html" class="nav-btn"><span class="nav-emoji">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span></a></div></nav>
  
  <!-- Yandex Metrika -->
  <script type="text/javascript">(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106461013', 'ym');ym(106461013, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});</script>
  <noscript><div><img src="https://mc.yandex.ru/watch/106461013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  
  <script>
    // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (50 –Ω–æ–≤–æ—Å—Ç–µ–π) –¥–ª—è PWA/—Å–∞–π—Ç–∞.
    var NEWS_CACHE_KEY = 'newsCache_v1';
    var NEWS_CACHE_LIMIT = 50;

    function readNewsCache() {
      try {
        var raw = localStorage.getItem(NEWS_CACHE_KEY);
        if (!raw) return null;
        var parsed = JSON.parse(raw);
        var posts = Array.isArray(parsed) ? parsed : parsed.posts;
        if (!Array.isArray(posts)) return null;
        return posts;
      } catch (e) {
        return null;
      }
    }

    function writeNewsCache(posts) {
      try {
        var limited = (posts || []).slice(0, NEWS_CACHE_LIMIT);
        localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({ savedAt: Date.now(), posts: limited }));
      } catch (e) {}
    }

    // –î–∞–¥–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—á–∏—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
    window.__pwaCleanup = function () {
      try {
        if (window.__newsAutoRefreshInterval) {
          clearInterval(window.__newsAutoRefreshInterval);
          window.__newsAutoRefreshInterval = null;
        }
      } catch (e) {}
    };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (localStorage)
    function getUserReactions() {
      var stored = localStorage.getItem('userReactions');
      return stored ? JSON.parse(stored) : {};
    }
    
    function saveUserReaction(postId, reactionType) {
      var reactions = getUserReactions();
      if (reactionType) {
        reactions[postId] = reactionType;
      } else {
        delete reactions[postId];
      }
      localStorage.setItem('userReactions', JSON.stringify(reactions));
    }
    
    function getUserReactionForPost(postId) {
      var reactions = getUserReactions();
      return reactions[postId] || null;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥—ã –∞–¥–∞–ø—Ç–µ—Ä–∞
    function isUserAuthenticated() { return window.appAdapter?.isAuthenticated() || false; }
    function showAuthModal() { document.getElementById('authModal').classList.add('active'); window.appAdapter?.vibrate('warning'); }
    function closeAuthModal() { document.getElementById('authModal').classList.remove('active'); }
    function goToProfile() { window.location.href = 'profile.html'; }
    
    function toggleTheme() { 
      var body = document.body; 
      var icon = document.getElementById('theme-icon'); 
      var isDark = body.getAttribute('data-theme') === 'dark'; 
      body.setAttribute('data-theme', isDark ? '' : 'dark'); 
      icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è'; 
      localStorage.setItem('theme', isDark ? 'light' : 'dark'); 
      
      // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –¥–ª—è Telegram –µ—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ Mini App
      if (window.appAdapter?.mode === 'telegram-mini-app' && window.Telegram?.WebApp) {
        var tg = window.Telegram.WebApp;
        tg.setHeaderColor(isDark ? '#f0f2f5' : '#0e0e0e'); 
        tg.setBackgroundColor(isDark ? '#f0f2f5' : '#0e0e0e'); 
      }
    }
    
    function initTheme() { 
      var saved = localStorage.getItem('theme'); 
      var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; 
      var useDark = saved === 'dark' || (!saved && prefersDark); 
      if (useDark) { 
        document.body.setAttribute('data-theme', 'dark'); 
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è'; 
      } 
    }
    
    function escapeHtml(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }
    function formatText(n) { if (n.textHTML) return n.textHTML; var safe = escapeHtml(n.text || ''); var urlRegex = /(https?:\/\/[^\s]+)/g; return safe.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>'); }
    function formatDate(ts) { if (!ts) return ''; var d = new Date(ts); var day = String(d.getDate()).padStart(2, '0'); var month = String(d.getMonth() + 1).padStart(2, '0'); var year = d.getFullYear(); var hours = String(d.getHours()).padStart(2, '0'); var minutes = String(d.getMinutes()).padStart(2, '0'); return `${day}.${month}.${year}, ${hours}:${minutes}`; }
    function buildSourceLine(n) { var s = n && n.source ? n.source : null; if (!s) return ''; var url = s.postUrl || s.chatUrl || ''; var title = s.title || (s.username ? '@' + s.username : '–ò—Å—Ç–æ—á–Ω–∏–∫'); if (!url) return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: ${escapeHtml(title)}`; return ` ¬∑ –ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`; }
    
    // AI Summary Functions
    var summaryCache = null;
    var summaryLoading = false;
    
    async function loadSummary() {
      if (summaryLoading) return;
      
      var btn = document.getElementById('summaryBtn');
      var card = document.getElementById('summaryCard');
      
      if (card.style.display === 'block') {
        card.style.display = 'none';
        btn.innerHTML = '<span>ü§ñ</span><span>–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è?</span>';
        window.appAdapter?.vibrate('light');
        return;
      }
      
      summaryLoading = true;
      btn.disabled = true;
      btn.innerHTML = '<span>‚è≥</span><span>–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–≤–æ–¥–∫—É...</span>';
      window.appAdapter?.vibrate('medium');
      
      try {
        var res = await fetch('/api/summary', { method: 'GET', cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        var data = await res.json();
        if (data.success) {
          summaryCache = data;
          displaySummary(data);
          window.appAdapter?.vibrate('success');
        } else {
          throw new Error(data.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        }
      } catch (error) {
        console.error('Summary error:', error);
        card.innerHTML = `
          <div class="summary-card">
            <div class="summary-header"><span>‚ö†Ô∏è</span><span>–û—à–∏–±–∫–∞</span><button class="summary-close" onclick="closeSummary()">&times;</button></div>
            <div class="summary-text">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>
          </div>
        `;
        card.style.display = 'block';
        window.appAdapter?.vibrate('error');
      } finally {
        summaryLoading = false;
        btn.disabled = false;
        btn.innerHTML = '<span>ü§ñ</span><span>–°–∫—Ä—ã—Ç—å —Å–≤–æ–¥–∫—É</span>';
      }
    }
    
    function displaySummary(data) {
      var card = document.getElementById('summaryCard');
      var today = new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
      card.innerHTML = `
        <div class="summary-card">
          <div class="summary-header"><span>ü§ñ</span><span>–°–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</span><button class="summary-close" onclick="closeSummary()">&times;</button></div>
          <div class="summary-text">${escapeHtml(data.summary)}</div>
          <div class="summary-footer"><span>üìÖ ${today}</span><span>üì∞ ${data.count} –Ω–æ–≤–æ—Å—Ç${data.count === 1 ? '—å' : data.count < 5 ? '–∏' : '–µ–π'}</span></div>
        </div>
      `;
      card.style.display = 'block';
    }
    
    function closeSummary() {
      document.getElementById('summaryCard').style.display = 'none';
      document.getElementById('summaryBtn').innerHTML = '<span>ü§ñ</span><span>AI: –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è?</span>';
      window.appAdapter?.vibrate('light');
    }
    
    async function handleReaction(postId, type, event) {
      if (!isUserAuthenticated()) {
        showAuthModal();
        return;
      }
      
      var btn = event.currentTarget;
      var userId = window.appAdapter?.getUserId() || 'unknown';
      var otherType = type === 'like' ? 'dislike' : 'like';
      var otherBtn = btn.parentElement.querySelector(`[data-type="${otherType}"]`);
      var wasActive = btn.classList.contains('active');
      var otherWasActive = otherBtn.classList.contains('active');
      
      window.appAdapter?.vibrate('light');
      
      btn.classList.add('animating');
      setTimeout(() => btn.classList.remove('animating'), 300);
      
      var newLikes = parseInt(btn.parentElement.querySelector('[data-type="like"] .count').textContent);
      var newDislikes = parseInt(btn.parentElement.querySelector('[data-type="dislike"] .count').textContent);
      var newReaction = null;
      
      if (wasActive) {
        btn.classList.remove('active');
        if (type === 'like') newLikes = Math.max(0, newLikes - 1);
        else newDislikes = Math.max(0, newDislikes - 1);
        newReaction = null;
      } else {
        if (otherWasActive) {
          otherBtn.classList.remove('active');
          if (type === 'like') newDislikes = Math.max(0, newDislikes - 1);
          else newLikes = Math.max(0, newLikes - 1);
        }
        btn.classList.add('active');
        if (type === 'like') newLikes++;
        else newDislikes++;
        newReaction = type;
      }
      
      saveUserReaction(postId, newReaction);
      btn.parentElement.querySelector('[data-type="like"] .count').textContent = newLikes;
      btn.parentElement.querySelector('[data-type="dislike"] .count').textContent = newDislikes;
      
      try {
        var res = await fetch('/api/reactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId, type, userId })
        });
        
        if (!res.ok) throw new Error('Failed to update reaction');
        var data = await res.json();
        
        btn.parentElement.querySelector('[data-type="like"] .count').textContent = data.likes || 0;
        btn.parentElement.querySelector('[data-type="dislike"] .count').textContent = data.dislikes || 0;
        
        var likeBtn = btn.parentElement.querySelector('[data-type="like"]');
        var dislikeBtn = btn.parentElement.querySelector('[data-type="dislike"]');
        likeBtn.classList.toggle('active', data.userReaction === 'like');
        dislikeBtn.classList.toggle('active', data.userReaction === 'dislike');
        saveUserReaction(postId, data.userReaction);
      } catch (error) {
        console.error('Reaction error:', error);
      }
    }
    
    var allNews = [];
    var isLoading = false;
    var hasMore = true;
    var currentOffset = 0;
    var LIMIT = 10;
    
    function renderNews() {
      var feed = document.getElementById('feed');
      if (!feed) return;

      var filtered = allNews.filter(n => (n.category || 'all') !== 'reco');
      
      if (!filtered.length && !hasMore) {
        feed.innerHTML = '<div class="no-news">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –Ω–æ–≤–æ—Å—Ç—å –±–æ—Ç—É.</div>';
        return;
      }
      
      var cardsHtml = filtered.map(n => {
        var ts = n.timestamp || n.createdAt || null;
        var html = '<div class="card">';
        html += `<div class="card-meta">#${escapeHtml(n.id)} ¬∑ ${escapeHtml(formatDate(ts))}${buildSourceLine(n)}</div>`;
        
        var media = n.media || [];
        var mediaItems = media.filter(m => m && m.fileId && (m.type === 'photo' || m.type === 'video'));
        
        if (mediaItems.length > 0) {
          html += '<div class="card-media-scroll">';
          mediaItems.forEach(item => {
            var mediaUrl = `/api/media?fileId=${encodeURIComponent(item.fileId)}`;
            if (item.type === 'photo') {
              html += `<img src="${mediaUrl}" loading="lazy" alt="–§–æ—Ç–æ" onerror="this.style.display='none'"/>`;
            } else if (item.type === 'video') {
              html += `<video controls preload="metadata" playsinline onerror="this.style.display='none'"><source src="${mediaUrl}" type="video/mp4">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>`;
            }
          });
          html += '</div>';
        }
        
        html += `<div class="card-text">${formatText(n)}</div>`;
        
        var likes = n.likes || 0;
        var dislikes = n.dislikes || 0;
        var userReaction = getUserReactionForPost(n.id);
        
        html += '<div class="card-reactions">';
        html += `<div class="reaction-btn ${userReaction === 'like' ? 'active' : ''}" data-type="like" onclick="handleReaction(${n.id}, 'like', event)"><span class="emoji">üëç</span><span class="count">${likes}</span></div>`;
        html += `<div class="reaction-btn ${userReaction === 'dislike' ? 'active' : ''}" data-type="dislike" onclick="handleReaction(${n.id}, 'dislike', event)"><span class="emoji">üëé</span><span class="count">${dislikes}</span></div>`;
        html += '</div></div>';
        
        return html;
      }).join('');
      
      var loadMoreHtml = '';
      if (hasMore) {
        loadMoreHtml = `<div class="load-more"><button class="load-more-btn" onclick="loadMore()" ${isLoading ? 'disabled' : ''}>${isLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë'}</button></div>`;
      }
      
      feed.innerHTML = cardsHtml + loadMoreHtml;
    }

    function restoreFromCacheIfNeeded() {
      if (allNews && allNews.length) return;
      var cached = readNewsCache();
      if (cached && cached.length) {
        allNews = cached;
        currentOffset = allNews.length;
        hasMore = true;
        renderNews();
      }
    }
    
    async function loadNews({ append = false } = {}) {
      if (isLoading) return;
      isLoading = true;
      if (!append) renderNews();
      
      try {
        var url = `/api/news?limit=${LIMIT}&offset=${currentOffset}&t=${Date.now()}`;
        var res = await fetch(url, { cache: 'no-store', headers: { 'Accept': 'application/json' } });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        var data = await res.json();
        var newPosts = Array.isArray(data.posts) ? data.posts : [];
        
        if (append) allNews = [...allNews, ...newPosts];
        else allNews = newPosts;

        // –•—Ä–∞–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–æ 50 –Ω–æ–≤–æ—Å—Ç–µ–π (—Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–ª–æ—Å—å –≤ –ª–µ–Ω—Ç–µ)
        writeNewsCache(allNews);
        
        hasMore = data.hasMore || false;
        currentOffset = allNews.length;
        
        renderNews();
      } catch (e) {
        console.error('Failed to load news:', e);

        // fallback: –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        restoreFromCacheIfNeeded();

        if (!allNews.length) {
          var feed = document.getElementById('feed');
          if (feed) {
            feed.innerHTML = `<div class="error-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π: ${escapeHtml(e.message)}<br><br><button onclick="loadNews()" style="padding:8px 16px;border-radius:20px;border:none;background:#007aff;color:#fff;cursor:pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>`;
          }
        }
      } finally {
        isLoading = false;
      }
    }
    
    async function loadMore() {
      await loadNews({ append: true });
    }

    // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π (–æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
    try {
      if (window.__newsAutoRefreshInterval) {
        clearInterval(window.__newsAutoRefreshInterval);
      }
    } catch (e) {}

    window.__newsAutoRefreshInterval = setInterval(async () => {
      if (document.visibilityState === 'visible' && !isLoading) {
        var url = `/api/news?limit=${LIMIT}&offset=0&t=${Date.now()}`;
        try {
          var res = await fetch(url, { cache: 'no-store' });
          if (res.ok) {
            var data = await res.json();
            var newPosts = Array.isArray(data.posts) ? data.posts : [];
            if (newPosts.length > 0) {
              var hasChanges = newPosts[0].id !== allNews[0]?.id || newPosts.length !== allNews.slice(0, LIMIT).length;
              if (hasChanges) {
                console.log('[AUTO-REFRESH] New content detected, reloading...');
                currentOffset = 0;
                await loadNews();
              }
            }
          }
        } catch (e) {
          // –æ—Ñ–ª–∞–π–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º
        }
      }
    }, 3000);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initTheme();

    // 0) –°–Ω–∞—á–∞–ª–∞ —Ä–∏—Å—É–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞, —á—Ç–æ–±—ã –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ PWA –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª.
    try {
      var cached = readNewsCache();
      if (cached && cached.length) {
        allNews = cached;
        currentOffset = allNews.length;
        hasMore = true;
        renderNews();
      }
    } catch (e) {}

    // 1) –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Å–µ—Ç–∏
    if (window.appAdapter) {
      console.log('[NEWS] Adapter ready, mode:', window.appAdapter.mode);
      loadNews();
    } else {
      window.addEventListener('DOMContentLoaded', () => {
        console.log('[NEWS] DOM loaded, starting news load');
        loadNews();
      });
    }

    // 2) –ù–∞ –≤–æ–∑–≤—Ä–∞—Ç–µ (bfcache / popstate) ‚Äî –µ—Å–ª–∏ DOM –ø—É—Å—Ç–æ–π, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫—ç—à–∞
    window.addEventListener('pageshow', () => {
      restoreFromCacheIfNeeded();
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') restoreFromCacheIfNeeded();
    });
  </script>
</body>
</html>
